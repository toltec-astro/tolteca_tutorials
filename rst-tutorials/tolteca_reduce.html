<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta content="filterTutorials, filterDataReduction" name="keywords" />
<meta content="filterTutorials," name="keywords" />

    <title>Work with the data reduction submodule &#8212; tolteca_tutorials v0.0.dev</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap_sandstone.css" />
    <link rel="stylesheet" type="text/css" href="../_static/astropy.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <script src="../_static/searchtools.js"></script>
    <script src="https://use.fontawesome.com/3168e95f94.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="shortcut icon" href="../_static/astropy_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript">
    jQuery(function() { Search.loadIndex("../searchindex.js"); });
  </script>
  
  <script type="text/javascript" id="searchindexloader"></script>
   

  </head><body>


<nav class="navbar navbar-expand-lg bg-navbar">
  <a class="navbar-brand" href="/" style="padding: 0px 5px;">
    <img src="../../_static/toltec_logo.png" onerror="this.onerror=null;this.src='../_static/toltec_logo.png';" style="height: 38px;">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarColor01">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item active">
        <a class="nav-link" href="http://toltecdr.astro.umass.edu"/>TolTECA<span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Modules</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0" action="../search.html" method="get">
      <div class="input-group-prepend">
          <button class="input-group-text" style="padding: 0.7rem"><i class="fa fa-search fa-fw"></i></button>
      </div>
      <input class="form-control mr-sm-3" name="q" type="text" placeholder="Search the universe" />
    </form>
  </div>
</nav>


<div class="container">
  <div class="row">

    
    
    

    
    <div class="col-md-3">
      <div id="sidebar" class="bs-sidenav card" role="complementary">
        <h3>Table of contents</h3>
        <ul>
<li><a class="reference internal" href="#">Work with the data reduction submodule</a><ul>
<li><a class="reference internal" href="#authors">Authors</a></li>
<li><a class="reference internal" href="#learning-goals">Learning Goals</a></li>
<li><a class="reference internal" href="#keywords">Keywords</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#lets-first-create-a-runtime-context-object">Let’s first create a runtime context object.</a></li>
<li><a class="reference internal" href="#create-simulated-data">Create simulated data</a></li>
</ul>
</li>
</ul>

      </div>
    </div>
    

    <div class="col-md-9">
      <div class="content-padding card">
        <div>
  <p>None</p>
<a href="../_static/tolteca_reduce/tolteca_reduce.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/tolteca_reduce/tolteca_reduce.ipynb"><button id="binder">Interactive tutorial notebook</button></a>

<div id="spacer"></div><div class="section" id="work-with-the-data-reduction-submodule">
<span id="tolteca-reduce"></span><h1>Work with the data reduction submodule<a class="headerlink" href="#work-with-the-data-reduction-submodule" title="Permalink to this headline">¶</a></h1>
<div class="section" id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Zhiyuan Ma</p>
</div>
<div class="section" id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Learn the concept of <code class="docutils literal notranslate"><span class="pre">RuntimeContext</span></code>, which is the primary
interface to run data related tasks.</p></li>
<li><p>Reduce an example TolTEC observation.</p></li>
</ul>
</div>
<div class="section" id="keywords">
<h2>Keywords<a class="headerlink" href="#keywords" title="Permalink to this headline">¶</a></h2>
<p>Data reduction</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will create a simulated TolTEC observation and
reduce it.</p>
<p>To proceed, we need to first setup a tolteca working directory
(workdir).</p>
<p>A tolteca workdir is a directory prepared by tolteca, which contains
special subdirs recognized by the tolteca, as well as a set of runtime
config files in YAML format.</p>
<p>Tolteca workdir provides the user experience similar to a python virutal
environment. User can create many workdirs and each has its own
configuration setup for a certain task or project. The configurations
are picked up automatically when invoking <code class="docutils literal notranslate"><span class="pre">tolteca</span> <span class="pre">...</span></code> command in the
shell when in a particular tolteca workdir.</p>
<p>Under the hood, the in-memory representation of a workdir in tolteca is
an instance of <code class="docutils literal notranslate"><span class="pre">tolteca.utils.RuntimeContext</span></code>. All funtionalities
related to tolteca workdir are defined as some methods of this class (or
some subclass of it). The runtime context is the core object that user
would be dealing with in tolteca when working in the IPython prompt or
Jupyter notebook.</p>
<p>The first part of the tutorial gives a walk through of the concept of
runtime context and workdir. We will show how to setup from scratch a
workdir for running tolteca.simu module from Cell 1-7. Note that in the
tutorial, we create the workdir in a temporary folder, however, one is
encouraged to setup the workdir in his or her own user space, to match
the actual use case. The tolteca.cli module provides a command
<code class="docutils literal notranslate"><span class="pre">tolteca</span> <span class="pre">setup</span></code> to setup a workdir in the shell:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ cd /path/to/hold/workdir
$ tolteca setup example_tolteca_workdir
$ cd example_tolteca_workdir &amp;&amp; ls  # check the content
50_setup.yaml  bin/  cal/  log/
</pre></div>
</div>
<p>then one can just copy over one of the example configurations for the
simulator stored in
<code class="docutils literal notranslate"><span class="pre">`tolteca/data/examples/</span></code> &lt;<a class="reference external" href="https://github.com/toltec-astro/tolteca/tree/master/tolteca/data/examples">https://github.com/toltec-astro/tolteca/tree/master/tolteca/data/examples</a>&gt;`__
to the workdir. Once the workdir is in place and has all the necessary
bits, on can jump right into the second part of the tutorial starting
<a class="reference external" href="#cell8">Cell 8</a>.</p>
</div>
<div class="section" id="lets-first-create-a-runtime-context-object">
<h2>Let’s first create a runtime context object.<a class="headerlink" href="#lets-first-create-a-runtime-context-object" title="Permalink to this headline">¶</a></h2>
<p>To make the tutorial independent of any user’s own system setup, we just
use a temporary directory here:</p>
<p><span class="inputnumrole">In[1]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import some common packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>  <span class="c1"># to manage the tempdir</span>

<span class="n">es</span> <span class="o">=</span> <span class="n">ExitStack</span><span class="p">()</span>
<span class="n">workdir</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">tolteca.utils</span> <span class="kn">import</span> <span class="n">RuntimeContext</span>

<span class="n">rc</span> <span class="o">=</span> <span class="n">RuntimeContext</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="n">dirpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[1]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">runtime</span> <span class="n">context</span> <span class="n">RuntimeContext</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmplgccgf4t/50_setup.yaml&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>To load the config, just access the <code class="docutils literal notranslate"><span class="pre">config</span></code> attribute:</p>
<p><span class="inputnumrole">In[2]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[2]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">SchemaMissingKeyError</span>                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">dde38748b755</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8</span><span class="o">.</span><span class="mi">8_1</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca_tutorials</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">cached_property</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
     <span class="mi">34</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_in_coroutine</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">35</span>
<span class="o">---&gt;</span> <span class="mi">36</span>         <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">37</span>         <span class="k">return</span> <span class="n">value</span>
     <span class="mi">38</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">145</span>                                 <span class="sa">f</span><span class="s2">&quot; No top level dict found.&quot;</span><span class="p">)</span>
    <span class="mi">146</span>                     <span class="n">rupdate</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">147</span>         <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="mi">148</span>         <span class="c1"># update runtime info</span>
    <span class="mi">149</span>         <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">validate_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
    <span class="mi">155</span>         <span class="k">if</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="mi">156</span>             <span class="k">return</span> <span class="kc">None</span>
<span class="o">--&gt;</span> <span class="mi">157</span>         <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config_schema</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="mi">158</span>
    <span class="mi">159</span>     <span class="nd">@classmethod</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8</span><span class="o">.</span><span class="mi">8_1</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca_tutorials</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">schema</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="mi">409</span>                 <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing key</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural_s</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">),</span> <span class="n">s_missing_keys</span><span class="p">)</span>
    <span class="mi">410</span>                 <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepend_schema_name</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">411</span>                 <span class="k">raise</span> <span class="n">SchemaMissingKeyError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="mi">412</span>             <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_extra_keys</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="mi">413</span>                 <span class="n">wrong_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="n">SchemaMissingKeyError</span><span class="p">:</span> <span class="n">Missing</span> <span class="n">key</span><span class="p">:</span> <span class="s1">&#39;setup&#39;</span>
</pre></div>
</div>
<p>The reason of the exception is that we have not “setup” the runtime
context properly. The setup step is to “initialize” the workdir, so
later tolteca runs can recognize the context. To setup,</p>
<p><span class="inputnumrole">In[3]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">tollan.utils.fmt</span> <span class="kn">import</span> <span class="n">pformat_yaml</span>  <span class="c1"># pretty print the config</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[3]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">16</span><span class="n">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">10.908</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev268</span><span class="o">+</span><span class="n">ga76764d</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method also support adding custom records as follows
(note the <code class="docutils literal notranslate"><span class="pre">overwrite=True</span></code>, otherwise the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> will not be on
an already setup runtime context):</p>
<p><span class="inputnumrole">In[4]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rc</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;my_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
    <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;boo&#39;</span><span class="p">}</span>
    <span class="p">},</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[4]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">16</span><span class="n">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">11.046</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev268</span><span class="o">+</span><span class="n">ga76764d</span>
</pre></div>
</div>
<p>Now we have the workdir setup, we can go back and pretend that we
already have a valid tolteca workdir, in which case we can just load the
runtime context directly without needing to create and setup again (note
how our custom records get loaded as well):</p>
<p><span class="inputnumrole">In[5]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">rc</span>  <span class="c1"># just to make sure we don&#39;t get confused with the old rc object.</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">RuntimeContext</span><span class="p">(</span><span class="n">rootpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[5]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">runtime</span> <span class="n">context</span> <span class="n">RuntimeContext</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmplgccgf4t/50_setup.yaml&#39;</span><span class="p">)]</span>
<span class="n">Config</span><span class="p">:</span>

<span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">16</span><span class="n">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">11.046</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev268</span><span class="o">+</span><span class="n">ga76764d</span>
</pre></div>
</div>
</div>
<div class="section" id="create-simulated-data">
<h2>Create simulated data<a class="headerlink" href="#create-simulated-data" title="Permalink to this headline">¶</a></h2>
<p>Tolteca.simu provides a set of tools to create simulated data. To run
the simulator, we will need our workdir that we just setup, but with
more information.</p>
<p>The tolteca.simu comes with its own subclass of <code class="docutils literal notranslate"><span class="pre">RuntimeContext</span></code>,
namely, <code class="docutils literal notranslate"><span class="pre">SimulatorRuntime</span></code>. The simulator runtime manages simulator
related configurations loaded from the workdir. To create the simulator
runtime, we do the follows:</p>
<p><span class="inputnumrole">In[6]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tolteca.simu</span> <span class="kn">import</span> <span class="n">SimulatorRuntime</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">SimulatorRuntime</span><span class="p">(</span><span class="n">rootpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[6]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">runtime</span> <span class="n">context</span> <span class="n">SimulatorRuntime</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmplgccgf4t/50_setup.yaml&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">SchemaMissingKeyError</span>                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">add96175c9b1</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="mi">4</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8</span><span class="o">.</span><span class="mi">8_1</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca_tutorials</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">cached_property</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
     <span class="mi">34</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_in_coroutine</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">35</span>
<span class="o">---&gt;</span> <span class="mi">36</span>         <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">37</span>         <span class="k">return</span> <span class="n">value</span>
     <span class="mi">38</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">145</span>                                 <span class="sa">f</span><span class="s2">&quot; No top level dict found.&quot;</span><span class="p">)</span>
    <span class="mi">146</span>                     <span class="n">rupdate</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">147</span>         <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="mi">148</span>         <span class="c1"># update runtime info</span>
    <span class="mi">149</span>         <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;runtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">validate_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
    <span class="mi">155</span>         <span class="k">if</span> <span class="n">cfg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="mi">156</span>             <span class="k">return</span> <span class="kc">None</span>
<span class="o">--&gt;</span> <span class="mi">157</span>         <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_config_schema</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="mi">158</span>
    <span class="mi">159</span>     <span class="nd">@classmethod</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8</span><span class="o">.</span><span class="mi">8_1</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca_tutorials</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">schema</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="mi">409</span>                 <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Missing key</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural_s</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">),</span> <span class="n">s_missing_keys</span><span class="p">)</span>
    <span class="mi">410</span>                 <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepend_schema_name</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="o">--&gt;</span> <span class="mi">411</span>                 <span class="k">raise</span> <span class="n">SchemaMissingKeyError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="mi">412</span>             <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_extra_keys</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="mi">413</span>                 <span class="n">wrong_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="n">SchemaMissingKeyError</span><span class="p">:</span> <span class="n">Missing</span> <span class="n">key</span><span class="p">:</span> <span class="s1">&#39;simu&#39;</span>
</pre></div>
</div>
<p>The reason of the exception is that we have not “setup” the simulator
properly. The simulator expects a branch of config entries under the key
<code class="docutils literal notranslate"><span class="pre">simu</span></code>, stored in one of the YAML files found in the workdir.</p>
<p>The tolteca.simu has a set of “built-in” configurations that one can use
readily, one of which is ‘toltec_point_source’. Let’s dump this config
to the workdir with file name “60_simu.yaml”. Note the format
<code class="docutils literal notranslate"><span class="pre">\d+_.+.yaml</span></code>, this is the convention of the YAML config files to be
recongnized by the tolteca runtime context. The files with lower number
are overriden by those with higher number.</p>
<p>Note that in the example config, it refers to a filepath
<code class="docutils literal notranslate"><span class="pre">toltec_sources.asc</span></code> in the <code class="docutils literal notranslate"><span class="pre">sources</span></code> list. This is an ASCII table
that defines the point sources to be injected on the sky. We need also
create this table.</p>
<p><span class="inputnumrole">In[7]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tolteca.simu</span> <span class="kn">import</span> <span class="n">example_configs</span> <span class="k">as</span> <span class="n">cfgs</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">cfgs</span><span class="p">[</span><span class="s1">&#39;toltec_point_source&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">rootpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;60_simu.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fo</span><span class="p">)</span>

<span class="c1"># create the point source catalog</span>
<span class="c1"># we just add two sources here. The column names</span>
<span class="c1"># used matches with those in the source definition `colname_map`, whose</span>
<span class="c1"># keys (a1100, etc) matches with the `grouping: array_name` setting.</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;s0&#39;</span><span class="p">,</span> <span class="mf">92.</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,],</span>
    <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="mf">92.</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.01</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,],</span>
    <span class="p">],</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_a1100&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_a1400&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_a2000&#39;</span><span class="p">],</span>
    <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">rootpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;toltec_sources.asc&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.ecsv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[7]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">simu</span><span class="p">:</span>
  <span class="n">instrument</span><span class="p">:</span>
    <span class="n">calobj</span><span class="p">:</span> <span class="n">cal</span><span class="o">/</span><span class="n">calobj_default</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">toltec</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">mapping</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="s1">&#39;1. arcmin&#39;</span>
    <span class="n">n_scans</span><span class="p">:</span> <span class="mi">40</span>
    <span class="n">ref_frame</span><span class="p">:</span> <span class="n">icrs</span>
    <span class="n">rot</span><span class="p">:</span> <span class="s1">&#39;0. deg&#39;</span>
    <span class="n">space</span><span class="p">:</span> <span class="s1">&#39;1.5 arcsec&#39;</span>
    <span class="n">speed</span><span class="p">:</span> <span class="s1">&#39;1. arcmin/s&#39;</span>
    <span class="n">t0</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">t_turnover</span><span class="p">:</span> <span class="s1">&#39;0.1 s&#39;</span>
    <span class="n">target</span><span class="p">:</span> <span class="s1">&#39;92d -7d&#39;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="p">:</span><span class="n">SkyRasterScanModel</span>
  <span class="n">obs_params</span><span class="p">:</span>
    <span class="n">f_smp_data</span><span class="p">:</span> <span class="s1">&#39;122. Hz&#39;</span>
    <span class="n">f_smp_mapping</span><span class="p">:</span> <span class="s1">&#39;12 Hz&#39;</span>
    <span class="n">t_exp</span><span class="p">:</span> <span class="s1">&#39;1 ct&#39;</span>
  <span class="n">sources</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">colname_map</span><span class="p">:</span>
        <span class="n">a1100</span><span class="p">:</span> <span class="n">flux_a1100</span>
        <span class="n">a1400</span><span class="p">:</span> <span class="n">flux_a1400</span>
        <span class="n">a2000</span><span class="p">:</span> <span class="n">flux_a2000</span>
        <span class="n">dec</span><span class="p">:</span> <span class="n">dec</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">name</span>
        <span class="n">ra</span><span class="p">:</span> <span class="n">ra</span>
      <span class="n">filepath</span><span class="p">:</span> <span class="n">toltec_sources</span><span class="o">.</span><span class="n">asc</span>
      <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">point_source_catalog</span>
</pre></div>
</div>
<p>Now we re-visit the <code class="docutils literal notranslate"><span class="pre">config</span></code> attribute of the simulator runtime. We
should see the new 60_simu.yaml file is suceessfully picked up and no
more complains about missing configuration keys.</p>
<p>For those returning readers who already have a workdir setup with
correct contents, you can start from this cell.</p>
<p><span class="inputnumrole">In[8]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you already have a workdir at some path so you can ignore Cells 1-7 and jump in from here:</span>
<span class="c1"># from tolteca.simu import SimulatorRuntime</span>
<span class="c1"># workdir = &#39;/the/path/to/a/workdir/with/simu/configs&#39;</span>
<span class="c1"># rc = SimulatorRuntime(rootpath=workdir)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[8]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="p">:</span>

<span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmplgccgf4t</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">16</span><span class="n">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">11.046</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev268</span><span class="o">+</span><span class="n">ga76764d</span>
<span class="n">simu</span><span class="p">:</span>
  <span class="n">instrument</span><span class="p">:</span>
    <span class="n">calobj</span><span class="p">:</span> <span class="n">cal</span><span class="o">/</span><span class="n">calobj_default</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">toltec</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">mapping</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="s1">&#39;1. arcmin&#39;</span>
    <span class="n">n_scans</span><span class="p">:</span> <span class="mi">40</span>
    <span class="n">ref_frame</span><span class="p">:</span> <span class="n">icrs</span>
    <span class="n">rot</span><span class="p">:</span> <span class="s1">&#39;0. deg&#39;</span>
    <span class="n">space</span><span class="p">:</span> <span class="s1">&#39;1.5 arcsec&#39;</span>
    <span class="n">speed</span><span class="p">:</span> <span class="s1">&#39;1. arcmin/s&#39;</span>
    <span class="n">t0</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">t_turnover</span><span class="p">:</span> <span class="s1">&#39;0.1 s&#39;</span>
    <span class="n">target</span><span class="p">:</span> <span class="s1">&#39;92d -7d&#39;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="p">:</span><span class="n">SkyRasterScanModel</span>
  <span class="n">mapping_only</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">obs_params</span><span class="p">:</span>
    <span class="n">f_smp_data</span><span class="p">:</span> <span class="mf">122.0</span> <span class="n">Hz</span>
    <span class="n">f_smp_mapping</span><span class="p">:</span> <span class="mf">12.0</span> <span class="n">Hz</span>
    <span class="n">t_exp</span><span class="p">:</span> <span class="mf">1.0</span> <span class="n">ct</span>
  <span class="n">perf_params</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">plot</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">save</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">sources</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">colname_map</span><span class="p">:</span>
        <span class="n">a1100</span><span class="p">:</span> <span class="n">flux_a1100</span>
        <span class="n">a1400</span><span class="p">:</span> <span class="n">flux_a1400</span>
        <span class="n">a2000</span><span class="p">:</span> <span class="n">flux_a2000</span>
        <span class="n">dec</span><span class="p">:</span> <span class="n">dec</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">name</span>
        <span class="n">ra</span><span class="p">:</span> <span class="n">ra</span>
      <span class="n">filepath</span><span class="p">:</span> <span class="n">toltec_sources</span><span class="o">.</span><span class="n">asc</span>
      <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">point_source_catalog</span>
</pre></div>
</div>
<p>The simulator configuration defines the on-the-fly mapping pattern, the
input sources, and the instrument to simulate. Under the hood, each of
these aspects is managed by its own class which implements the related
functionalities.</p>
<p>Let’s take a look at the mapping model first. We can make a plot of the
mapping pattern:</p>
<p><span class="inputnumrole">In[9]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mapping</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">get_mapping_model</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mapping model:</span><span class="se">\n</span><span class="si">{</span><span class="n">mapping</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># the time to finish the mapping can be obtained from the mapping model</span>
<span class="n">mapping_time</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get_total_time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time to finish mapping: </span><span class="si">{</span><span class="n">mapping_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># to plot the pattern, let&#39;s genrate some sampling points</span>
<span class="c1"># For plotting, we just use a linspace grid here, but in the actual simulator run</span>
<span class="c1"># it makes use of the obs params &quot;f_smp_mapping&quot; as the sampling frequency</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mapping_time</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">mapping_offsets</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># this is the offsets from bore sight</span>

<span class="c1"># to evaluate mapping pattern around a coordinates, use evaluate_at</span>
<span class="c1"># The frame of input coordinates will be assumed for the offsets</span>
<span class="c1"># here the mapping target from the config is given in equitorial</span>
<span class="c1"># so the mapping will be along equitorial coordinate frame</span>
<span class="n">target_coord</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">target</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mapping target: </span><span class="si">{</span><span class="n">mapping</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">mapping_coords</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">target_coord</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="c1"># the bore sight offsets</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mapping_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">),</span>
    <span class="n">mapping_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>  <span class="c1"># the target</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;lon. offset (arcmin)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;lat. offset (arcmin)&#39;</span><span class="p">)</span>

<span class="c1"># the sky coords, which we need an fiducial wcs object</span>
<span class="c1"># to plot in the ref frame of target coords, i.e., ICRS</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">celestial_frame_to_wcs</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">celestial_frame_to_wcs</span><span class="p">(</span><span class="n">target_coord</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
<span class="c1"># set the crval to target</span>
<span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">target_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>  <span class="c1"># a WCSAxes plot, see https://docs.astropy.org/en/stable/visualization/wcsaxes/index.html</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mapping_coords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
    <span class="n">mapping_coords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">target_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">target_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ticklabel</span><span class="p">(</span><span class="n">exclude_overlapping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># reduce the cluttering of tick labels.</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[9]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapping</span> <span class="n">model</span><span class="p">:</span>
<span class="n">Model</span><span class="p">:</span> <span class="n">SkyRasterScanModel</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Parameters</span><span class="p">:</span>
    <span class="n">length</span> <span class="n">space</span>  <span class="n">n_scans</span> <span class="n">rot</span>   <span class="n">speed</span>    <span class="n">t_turnover</span>
    <span class="n">arcmin</span> <span class="n">arcsec</span>         <span class="n">deg</span> <span class="n">arcmin</span> <span class="o">/</span> <span class="n">s</span>     <span class="n">s</span>
    <span class="o">------</span> <span class="o">------</span> <span class="o">-------</span> <span class="o">---</span> <span class="o">----------</span> <span class="o">----------</span>
       <span class="mf">1.0</span>    <span class="mf">1.5</span>    <span class="mf">40.0</span> <span class="mf">0.0</span>        <span class="mf">1.0</span>        <span class="mf">0.1</span>
<span class="n">time</span> <span class="n">to</span> <span class="n">finish</span> <span class="n">mapping</span><span class="p">:</span> <span class="mf">43.9</span> <span class="n">s</span>
<span class="n">mapping</span> <span class="n">target</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">SkyCoord</span> <span class="p">(</span><span class="n">ICRS</span><span class="p">):</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">deg</span>
    <span class="p">(</span><span class="mf">92.</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">InputWarning</span><span class="p">:</span> <span class="n">Coordinate</span> <span class="n">string</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">interpreted</span> <span class="k">as</span> <span class="n">an</span> <span class="n">ICRS</span> <span class="n">coordinate</span><span class="o">.</span> <span class="p">[</span><span class="n">astroquery</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">commons</span><span class="p">]</span>
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_17_2.png" src="../_images/tolteca_reduce_17_2.png" />
<p>For the input sources, the <code class="docutils literal notranslate"><span class="pre">sources</span></code> list specified in the simulator
configs is parsed and a set of <code class="docutils literal notranslate"><span class="pre">tolteca.simu.base.SourceModel</span></code>
subclass instances are created according to the <code class="docutils literal notranslate"><span class="pre">type</span></code> key. In this
case, we only have one model with type <code class="docutils literal notranslate"><span class="pre">point_source_catalog</span></code>. It is
specified in format of an ASCII table, which we just created:</p>
<p><span class="inputnumrole">In[10]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sources</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">get_source_model</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
<span class="n">m_point_source</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># take out the point source model and let&#39;s take a look</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model class is:</span><span class="se">\n</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">m_point_source</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model data:</span><span class="se">\n</span><span class="si">{</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model source positions: </span><span class="si">{</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># we can make a synetic image and plot by creating a SourceImageModel from the SourceCatalogModel</span>
<span class="c1"># to do this we need some beammodels and a pixelscale.</span>
<span class="c1"># we can use the toltec beammodels here, and assume a 1&quot;/pix scale</span>
<span class="kn">from</span> <span class="nn">tolteca.simu.toltec</span> <span class="kn">import</span> <span class="n">BeamModel</span>
<span class="n">m_img</span> <span class="o">=</span> <span class="n">m_point_source</span><span class="o">.</span><span class="n">make_image_model</span><span class="p">(</span><span class="n">beam_models</span><span class="o">=</span><span class="n">BeamModel</span><span class="p">()</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
<span class="c1"># the m_img is a SourceImageModel class which contains image data as a dict of ImageHDU.</span>
<span class="c1"># we create a set of WCSAxes to plot them</span>

<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">n_hdus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hdu</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hdus</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># label the sources</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">m_point_source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[10]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[&lt;SourceCatalogModel(name=&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmplgccgf4t/toltec_sources.asc&#39;)&gt;]
model class is:
&lt;class &#39;tolteca.simu.base.SourceCatalogModel&#39;&gt;
Name: SourceCatalogModel
N_inputs: 2
N_outputs: 1
model data:
a1100 a1400 a2000  dec  name  ra
 mJy   mJy   mJy   deg       deg
----- ----- ----- ----- ---- ----
  3.0   2.0   1.0  -7.0   s0 92.0
  1.0   1.0   1.0 -7.01   s1 92.0
model source positions: &lt;SkyCoord (ICRS): (ra, dec) in deg
    [(92., -7.  ), (92., -7.01)]&gt;
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_19_1.png" src="../_images/tolteca_reduce_19_1.png" />
<p><span class="inputnumrole">In[11]:</span></p>
<p><span class="inputnumrole">In[None]:</span></p>
<div id="spacer"></div>

<a href="../_static/tolteca_reduce/tolteca_reduce.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/tolteca_reduce/tolteca_reduce.ipynb"><button id="binder">Interactive tutorial notebook</button></a></div>
</div>

</div>
      </div>
      
    </div>
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.2.
    &copy; Copyright Astropy.
    </p>
  </div>
</footer>
  </body>
</html>