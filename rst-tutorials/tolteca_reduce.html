<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta content="filterTutorials, filterSimulation;DataReduction" name="keywords" />
<meta content="filterTutorials," name="keywords" />

    <title>Work with the data reduction submodule &#8212; tolteca_tutorials v0.0.dev</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap_sandstone.css" />
    <link rel="stylesheet" type="text/css" href="../_static/astropy.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <script src="../_static/searchtools.js"></script>
    <script src="https://use.fontawesome.com/3168e95f94.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="shortcut icon" href="../_static/astropy_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript">
    jQuery(function() { Search.loadIndex("../searchindex.js"); });
  </script>
  
  <script type="text/javascript" id="searchindexloader"></script>
   

  </head><body>


<nav class="navbar navbar-expand-lg bg-navbar">
  <a class="navbar-brand" href="/" style="padding: 0px 5px;">
    <img src="../../_static/toltec_logo.png" onerror="this.onerror=null;this.src='../_static/toltec_logo.png';" style="height: 38px;">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarColor01">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item active">
        <a class="nav-link" href="http://toltecdr.astro.umass.edu"/>TolTECA<span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Modules</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0" action="../search.html" method="get">
      <div class="input-group-prepend">
          <button class="input-group-text" style="padding: 0.7rem"><i class="fa fa-search fa-fw"></i></button>
      </div>
      <input class="form-control mr-sm-3" name="q" type="text" placeholder="Search the universe" />
    </form>
  </div>
</nav>


<div class="container">
  <div class="row">

    
    
    

    
    <div class="col-md-3">
      <div id="sidebar" class="bs-sidenav card" role="complementary">
        <h3>Table of contents</h3>
        <ul>
<li><a class="reference internal" href="#">Work with the data reduction submodule</a><ul>
<li><a class="reference internal" href="#authors">Authors</a></li>
<li><a class="reference internal" href="#learning-goals">Learning Goals</a></li>
<li><a class="reference internal" href="#keywords">Keywords</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#installing-citlali">Installing Citlali</a></li>
<li><a class="reference internal" href="#lets-first-create-a-runtime-context-object">Let’s first create a runtime context object.</a></li>
<li><a class="reference internal" href="#create-simulated-data">Create simulated data</a></li>
<li><a class="reference internal" href="#reduce-the-simulated-observation">Reduce the simulated observation</a></li>
</ul>
</li>
</ul>

      </div>
    </div>
    

    <div class="col-md-9">
      <div class="content-padding card">
        <div>
  <p>None</p>
<a href="../_static/tolteca_reduce/tolteca_reduce.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/tolteca_reduce/tolteca_reduce.ipynb"><button id="binder">Interactive tutorial notebook</button></a>

<div id="spacer"></div><div class="section" id="work-with-the-data-reduction-submodule">
<span id="tolteca-reduce"></span><h1>Work with the data reduction submodule<a class="headerlink" href="#work-with-the-data-reduction-submodule" title="Permalink to this headline">¶</a></h1>
<div class="section" id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Zhiyuan Ma</p>
</div>
<div class="section" id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Learn the concept of <code class="docutils literal notranslate"><span class="pre">RuntimeContext</span></code>, which is the primary
interface to run data related tasks.</p></li>
<li><p>Reduce an example TolTEC observation.</p></li>
</ul>
</div>
<div class="section" id="keywords">
<h2>Keywords<a class="headerlink" href="#keywords" title="Permalink to this headline">¶</a></h2>
<p>Simulation; Data reduction</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p><strong>Note</strong>: The tolteca provides a commandline interface for running the
simuator and reduction, which hides a lot of implementation details and
is suitable for light users. This notebook aims to provide a in-depth
overview of some of the key components behind the scene. The commandline
interface tutorial can be found here:
<a class="reference external" href="https://github.com/toltec-astro/tolteca/blob/main/docs/tolteca/toltec_simu_tutorial.md">https://github.com/toltec-astro/tolteca/blob/main/docs/tolteca/toltec_simu_tutorial.md</a></p>
<p>In this tutorial, we will create a simulated TolTEC observation and
reduce it.</p>
<p>To proceed, we need to first setup a tolteca working directory
(workdir).</p>
<p>A tolteca workdir is a directory prepared by tolteca, which contains
special subdirs recognized by the tolteca, as well as a set of runtime
config files in YAML format.</p>
<p>Tolteca workdir provides the user experience similar to a python virutal
environment. User can create many workdirs and each has its own
configuration setup for a certain task or project. The configurations
are picked up automatically when invoking <code class="docutils literal notranslate"><span class="pre">tolteca</span> <span class="pre">...</span></code> command in the
shell when in a particular tolteca workdir.</p>
<p>Under the hood, the in-memory representation of a workdir in tolteca is
an instance of <code class="docutils literal notranslate"><span class="pre">tolteca.utils.RuntimeContext</span></code>. All funtionalities
related to tolteca workdir are defined as some methods of this class (or
some subclass of it). The runtime context is the core object that user
would be dealing with in tolteca when working in the IPython prompt or
Jupyter notebook.</p>
<p>The first part of the tutorial gives a walk through of the concept of
runtime context and workdir. We will show how to setup from scratch a
workdir for running tolteca.simu module from Cell 1-7. Note that in the
tutorial, we create the workdir in a temporary folder, however, one is
encouraged to setup the workdir in his or her own user space, to match
the actual use case. The tolteca.cli module provides a command
<code class="docutils literal notranslate"><span class="pre">tolteca</span> <span class="pre">setup</span></code> to setup a workdir in the shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd /path/to/hold/workdir
$ tolteca setup example_tolteca_workdir
$ cd example_tolteca_workdir &amp;&amp; ls  # check the content
50_setup.yaml  bin/  cal/  log/
</pre></div>
</div>
<p>then one can just copy over one of the example configurations for the
simulator stored in
<code class="docutils literal notranslate"><span class="pre">`tolteca/data/examples/</span></code> &lt;<a class="reference external" href="https://github.com/toltec-astro/tolteca/tree/master/tolteca/data/examples">https://github.com/toltec-astro/tolteca/tree/master/tolteca/data/examples</a>&gt;`__
to the workdir. Once the workdir is in place and has all the necessary
bits, on can jump right into the second part of the tutorial starting
<a class="reference external" href="#cell8">Cell 8</a>.</p>
</div>
<div class="section" id="installing-citlali">
<h2>Installing Citlali<a class="headerlink" href="#installing-citlali" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Citlali</span></code> is the TolTEC data reduction pipeline engine, which needs to
be installed in order to run the part of this tutorial related to data
reduction (Cell 22). You’ll need to revise the path to the citlali
executable in Cell 22 to make it avaliable to <code class="docutils literal notranslate"><span class="pre">tolteca.reduce</span></code>. For
instruction of installing citlali, visit
<a class="reference external" href="https://github.com/toltec-astro/citlali">https://github.com/toltec-astro/citlali</a>.</p>
</div>
<div class="section" id="lets-first-create-a-runtime-context-object">
<h2>Let’s first create a runtime context object.<a class="headerlink" href="#lets-first-create-a-runtime-context-object" title="Permalink to this headline">¶</a></h2>
<p>To make the tutorial independent of any user’s own system setup, we just
use a temporary directory here:</p>
<p><span class="inputnumrole">In[1]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import some common packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="c1"># %matplotlib widget</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>  <span class="c1"># to manage the tempdir</span>

<span class="n">es</span> <span class="o">=</span> <span class="n">ExitStack</span><span class="p">()</span>
<span class="n">workdir</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">tolteca.utils</span> <span class="kn">import</span> <span class="n">RuntimeContext</span>

<span class="n">rc</span> <span class="o">=</span> <span class="n">RuntimeContext</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="n">dirpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[1]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">runtime</span> <span class="n">context</span> <span class="n">RuntimeContext</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/50_setup.yaml&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>To load the config, just access the <code class="docutils literal notranslate"><span class="pre">config</span></code> attribute:</p>
<p><span class="inputnumrole">In[2]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[2]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">SchemaMissingKeyError</span>                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">dde38748b755</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8.10</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">cached_property</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
     <span class="mi">34</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_in_coroutine</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">35</span>
<span class="o">---&gt;</span> <span class="mi">36</span>         <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">37</span>         <span class="k">return</span> <span class="n">value</span>
     <span class="mi">38</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">145</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    146         if self.is_persistent:</span>
<span class="s2">--&gt; 147             cfg = self.collect_config_from_files(</span>
<span class="s2">    148                     self.config_files, validate=True</span>
<span class="s2">    149                     )</span>


<span class="s2">~/Codes/toltec/py/tollan/tollan/utils/dirconf.py in collect_config_from_files(cls, config_files, validate)</span>
<span class="s2">    143                 rupdate(cfg, c)</span>
<span class="s2">    144         if validate:</span>
<span class="s2">--&gt; 145             cfg = cls.validate_config(cfg)</span>
<span class="s2">    146         return cfg</span>
<span class="s2">    147</span>


<span class="s2">~/Codes/toltec/py/tollan/tollan/utils/dirconf.py in validate_config(cls, cfg)</span>
<span class="s2">    148     @classmethod</span>
<span class="s2">    149     def validate_config(cls, cfg):</span>
<span class="s2">--&gt; 150         return cls.get_config_schema().validate(cfg)</span>
<span class="s2">    151</span>
<span class="s2">    152     @classmethod</span>


<span class="s2">/usr/local/Cellar/python@3.8/3.8.10/envs/tolteca/lib/python3.8/site-packages/schema.py in validate(self, data)</span>
<span class="s2">    409                 message = &quot;Missing key</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot; % (_plural_s(missing_keys), s_missing_keys)</span>
<span class="s2">    410                 message = self._prepend_schema_name(message)</span>
<span class="s2">--&gt; 411                 raise SchemaMissingKeyError(message, e.format(data) if e else None)</span>
<span class="s2">    412             if not self._ignore_extra_keys and (len(new) != len(data)):</span>
<span class="s2">    413                 wrong_keys = set(data.keys()) - set(new.keys())</span>


<span class="s2">SchemaMissingKeyError: Missing key: &#39;setup&#39;</span>
</pre></div>
</div>
<p>The reason of the exception is that we have not “setup” the runtime
context properly. The setup step is to “initialize” the workdir, so
later tolteca runs can recognize the context. To setup,</p>
<p><span class="inputnumrole">In[3]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rc</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">tollan.utils.fmt</span> <span class="kn">import</span> <span class="n">pformat_yaml</span>  <span class="c1"># pretty print the config</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[3]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span><span class="n">T03</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mf">35.102</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev323</span><span class="o">+</span><span class="n">g1c6dc6b</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method also support adding custom records as follows
(note the <code class="docutils literal notranslate"><span class="pre">overwrite=True</span></code>, otherwise the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> will not be on
an already setup runtime context):</p>
<p><span class="inputnumrole">In[4]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rc</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;my_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
    <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;boo&#39;</span><span class="p">}</span>
    <span class="p">},</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[4]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span><span class="n">T03</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mf">35.245</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev323</span><span class="o">+</span><span class="n">g1c6dc6b</span>
</pre></div>
</div>
<p>Now we have the workdir setup, we can go back and pretend that we
already have a valid tolteca workdir, in which case we can just load the
runtime context directly without needing to create and setup again (note
how our custom records get loaded as well):</p>
<p><span class="inputnumrole">In[5]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">rc</span>  <span class="c1"># just to make sure we don&#39;t get confused with the old rc object.</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">RuntimeContext</span><span class="p">(</span><span class="n">rootpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[5]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">runtime</span> <span class="n">context</span> <span class="n">RuntimeContext</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/50_setup.yaml&#39;</span><span class="p">)]</span>
<span class="n">Config</span><span class="p">:</span>

<span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span><span class="n">T03</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mf">35.245</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev323</span><span class="o">+</span><span class="n">g1c6dc6b</span>
</pre></div>
</div>
</div>
<div class="section" id="create-simulated-data">
<h2>Create simulated data<a class="headerlink" href="#create-simulated-data" title="Permalink to this headline">¶</a></h2>
<p>Tolteca.simu provides a set of tools to create simulated data. To run
the simulator, we will need our workdir that we just setup, but with
more information.</p>
<p>The tolteca.simu comes with its own subclass of <code class="docutils literal notranslate"><span class="pre">RuntimeContext</span></code>,
namely, <code class="docutils literal notranslate"><span class="pre">SimulatorRuntime</span></code>. The simulator runtime manages simulator
related configurations loaded from the workdir. To create the simulator
runtime, we do the follows:</p>
<p><span class="inputnumrole">In[6]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tolteca.simu</span> <span class="kn">import</span> <span class="n">SimulatorRuntime</span>
<span class="n">rc</span> <span class="o">=</span> <span class="n">SimulatorRuntime</span><span class="p">(</span><span class="n">rootpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[6]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">runtime</span> <span class="n">context</span> <span class="n">SimulatorRuntime</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/50_setup.yaml&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">SchemaMissingKeyError</span>                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">add96175c9b1</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created runtime context </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="mi">4</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">rc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8.10</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">cached_property</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
     <span class="mi">34</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_in_coroutine</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">35</span>
<span class="o">---&gt;</span> <span class="mi">36</span>         <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">37</span>         <span class="k">return</span> <span class="n">value</span>
     <span class="mi">38</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">145</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    146         if self.is_persistent:</span>
<span class="s2">--&gt; 147             cfg = self.collect_config_from_files(</span>
<span class="s2">    148                     self.config_files, validate=True</span>
<span class="s2">    149                     )</span>


<span class="s2">~/Codes/toltec/py/tollan/tollan/utils/dirconf.py in collect_config_from_files(cls, config_files, validate)</span>
<span class="s2">    143                 rupdate(cfg, c)</span>
<span class="s2">    144         if validate:</span>
<span class="s2">--&gt; 145             cfg = cls.validate_config(cfg)</span>
<span class="s2">    146         return cfg</span>
<span class="s2">    147</span>


<span class="s2">~/Codes/toltec/py/tollan/tollan/utils/dirconf.py in validate_config(cls, cfg)</span>
<span class="s2">    148     @classmethod</span>
<span class="s2">    149     def validate_config(cls, cfg):</span>
<span class="s2">--&gt; 150         return cls.get_config_schema().validate(cfg)</span>
<span class="s2">    151</span>
<span class="s2">    152     @classmethod</span>


<span class="s2">/usr/local/Cellar/python@3.8/3.8.10/envs/tolteca/lib/python3.8/site-packages/schema.py in validate(self, data)</span>
<span class="s2">    409                 message = &quot;Missing key</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot; % (_plural_s(missing_keys), s_missing_keys)</span>
<span class="s2">    410                 message = self._prepend_schema_name(message)</span>
<span class="s2">--&gt; 411                 raise SchemaMissingKeyError(message, e.format(data) if e else None)</span>
<span class="s2">    412             if not self._ignore_extra_keys and (len(new) != len(data)):</span>
<span class="s2">    413                 wrong_keys = set(data.keys()) - set(new.keys())</span>


<span class="s2">SchemaMissingKeyError: Missing key: &#39;simu&#39;</span>
</pre></div>
</div>
<p>The reason of the exception is that we have not “setup” the simulator
properly. The simulator expects a branch of config entries under the key
<code class="docutils literal notranslate"><span class="pre">simu</span></code>, stored in one of the YAML files found in the workdir.</p>
<p>The tolteca.simu has a set of “built-in” configurations that one can use
readily, one of which is ‘toltec_point_source’. Let’s dump this config
to the workdir with file name “60_simu.yaml”. Note the format
<code class="docutils literal notranslate"><span class="pre">\d+_.+.yaml</span></code>, this is the convention of the YAML config files to be
recongnized by the tolteca runtime context. The files with lower number
are overriden by those with higher number.</p>
<p>Note that in the example config, it refers to a filepath
<code class="docutils literal notranslate"><span class="pre">toltec_sources.asc</span></code> in the <code class="docutils literal notranslate"><span class="pre">sources</span></code> list. This is an ASCII table
that defines the point sources to be injected on the sky. We need also
create this table.</p>
<p><span class="inputnumrole">In[7]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tolteca.simu</span> <span class="kn">import</span> <span class="n">example_configs</span> <span class="k">as</span> <span class="n">cfgs</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">cfgs</span><span class="p">[</span><span class="s1">&#39;toltec_point_source&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">rootpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;60_simu.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fo</span><span class="p">)</span>

<span class="c1"># create the point source catalog</span>
<span class="c1"># we just add two sources here. The column names</span>
<span class="c1"># used matches with those in the source definition `colname_map`, whose</span>
<span class="c1"># keys (a1100, etc) matches with the `grouping: array_name` setting.</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;s0&#39;</span><span class="p">,</span> <span class="mf">92.</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,],</span>
    <span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="mf">92.</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.01</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,],</span>
    <span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span> <span class="mf">92.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_a1100&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_a1400&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_a2000&#39;</span><span class="p">],</span>
    <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">rootpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;toltec_sources.asc&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.ecsv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[7]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">simu</span><span class="p">:</span>
  <span class="n">instrument</span><span class="p">:</span>
    <span class="n">calobj</span><span class="p">:</span> <span class="n">cal</span><span class="o">/</span><span class="n">calobj_default</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">toltec</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">mapping</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="s1">&#39;1. arcmin&#39;</span>
    <span class="n">n_scans</span><span class="p">:</span> <span class="mi">40</span>
    <span class="n">ref_frame</span><span class="p">:</span> <span class="n">icrs</span>
    <span class="n">rot</span><span class="p">:</span> <span class="s1">&#39;0. deg&#39;</span>
    <span class="n">space</span><span class="p">:</span> <span class="s1">&#39;1.5 arcsec&#39;</span>
    <span class="n">speed</span><span class="p">:</span> <span class="s1">&#39;1. arcmin/s&#39;</span>
    <span class="n">t0</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">t_turnover</span><span class="p">:</span> <span class="s1">&#39;0.1 s&#39;</span>
    <span class="n">target</span><span class="p">:</span> <span class="s1">&#39;92d -7d&#39;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="p">:</span><span class="n">SkyRasterScanModel</span>
  <span class="n">obs_params</span><span class="p">:</span>
    <span class="n">f_smp_data</span><span class="p">:</span> <span class="s1">&#39;122. Hz&#39;</span>
    <span class="n">f_smp_mapping</span><span class="p">:</span> <span class="s1">&#39;12 Hz&#39;</span>
    <span class="n">t_exp</span><span class="p">:</span> <span class="s1">&#39;1 ct&#39;</span>
  <span class="n">sources</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">colname_map</span><span class="p">:</span>
        <span class="n">a1100</span><span class="p">:</span> <span class="n">flux_a1100</span>
        <span class="n">a1400</span><span class="p">:</span> <span class="n">flux_a1400</span>
        <span class="n">a2000</span><span class="p">:</span> <span class="n">flux_a2000</span>
        <span class="n">dec</span><span class="p">:</span> <span class="n">dec</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">name</span>
        <span class="n">ra</span><span class="p">:</span> <span class="n">ra</span>
      <span class="n">filepath</span><span class="p">:</span> <span class="n">toltec_sources</span><span class="o">.</span><span class="n">asc</span>
      <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">point_source_catalog</span>
    <span class="o">-</span> <span class="n">atm_model_name</span><span class="p">:</span> <span class="n">am_q50</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">toltec_array_loading</span>
</pre></div>
</div>
<p>Now we re-visit the <code class="docutils literal notranslate"><span class="pre">config</span></code> attribute of the simulator runtime. We
should see the new 60_simu.yaml file is suceessfully picked up and no
more complains about missing configuration keys.</p>
<p>For those returning readers who already have a workdir setup with
correct contents, you can start from this cell.</p>
<p><span class="inputnumrole">In[8]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you already have a workdir at some path so you can ignore Cells 1-7 and jump in from here:</span>
<span class="c1"># from tolteca.simu import SimulatorRuntime</span>
<span class="c1"># workdir = &#39;/the/path/to/a/workdir/with/simu/configs&#39;</span>
<span class="c1"># rc = SimulatorRuntime(rootpath=workdir)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[8]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="p">:</span>

<span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span><span class="n">T03</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mf">35.245</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev323</span><span class="o">+</span><span class="n">g1c6dc6b</span>
<span class="n">simu</span><span class="p">:</span>
  <span class="n">instrument</span><span class="p">:</span>
    <span class="n">calobj</span><span class="p">:</span> <span class="n">cal</span><span class="o">/</span><span class="n">calobj_default</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">toltec</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">mapping</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="s1">&#39;1. arcmin&#39;</span>
    <span class="n">n_scans</span><span class="p">:</span> <span class="mi">40</span>
    <span class="n">ref_frame</span><span class="p">:</span> <span class="n">icrs</span>
    <span class="n">rot</span><span class="p">:</span> <span class="s1">&#39;0. deg&#39;</span>
    <span class="n">space</span><span class="p">:</span> <span class="s1">&#39;1.5 arcsec&#39;</span>
    <span class="n">speed</span><span class="p">:</span> <span class="s1">&#39;1. arcmin/s&#39;</span>
    <span class="n">t0</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">t_turnover</span><span class="p">:</span> <span class="s1">&#39;0.1 s&#39;</span>
    <span class="n">target</span><span class="p">:</span> <span class="s1">&#39;92d -7d&#39;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="p">:</span><span class="n">SkyRasterScanModel</span>
  <span class="n">mapping_only</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">obs_params</span><span class="p">:</span>
    <span class="n">f_smp_data</span><span class="p">:</span> <span class="mf">122.0</span> <span class="n">Hz</span>
    <span class="n">f_smp_mapping</span><span class="p">:</span> <span class="mf">12.0</span> <span class="n">Hz</span>
    <span class="n">t_exp</span><span class="p">:</span> <span class="mf">1.0</span> <span class="n">ct</span>
  <span class="n">perf_params</span><span class="p">:</span>
    <span class="n">anim_frame_rate</span><span class="p">:</span> <span class="mf">12.0</span> <span class="n">Hz</span>
    <span class="n">chunk_size</span><span class="p">:</span> <span class="mf">10.0</span> <span class="n">s</span>
    <span class="n">erfa_interp_len</span><span class="p">:</span> <span class="mf">300.0</span> <span class="n">s</span>
    <span class="n">mapping_interp_len</span><span class="p">:</span> <span class="mf">1.0</span> <span class="n">s</span>
  <span class="n">plot</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">save</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">sources</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">colname_map</span><span class="p">:</span>
        <span class="n">a1100</span><span class="p">:</span> <span class="n">flux_a1100</span>
        <span class="n">a1400</span><span class="p">:</span> <span class="n">flux_a1400</span>
        <span class="n">a2000</span><span class="p">:</span> <span class="n">flux_a2000</span>
        <span class="n">dec</span><span class="p">:</span> <span class="n">dec</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">name</span>
        <span class="n">ra</span><span class="p">:</span> <span class="n">ra</span>
      <span class="n">filepath</span><span class="p">:</span> <span class="n">toltec_sources</span><span class="o">.</span><span class="n">asc</span>
      <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">point_source_catalog</span>
    <span class="o">-</span> <span class="n">atm_model_name</span><span class="p">:</span> <span class="n">am_q50</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">toltec_array_loading</span>
</pre></div>
</div>
<p>The simulator configuration defines the on-the-fly mapping pattern, the
input sources, and the instrument to simulate. Under the hood, each of
these aspects is managed by its own class which implements the related
functionalities.</p>
<p>Let’s take a look at the mapping model first. We can make a plot of the
mapping pattern:</p>
<p><span class="inputnumrole">In[9]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mapping</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">get_mapping_model</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mapping model:</span><span class="se">\n</span><span class="si">{</span><span class="n">mapping</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># the time to finish the mapping can be obtained from the mapping model</span>
<span class="n">mapping_time</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get_total_time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time to finish mapping: </span><span class="si">{</span><span class="n">mapping_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># to plot the pattern, let&#39;s genrate some sampling points</span>
<span class="c1"># For plotting, we just use a linspace grid here, but in the actual simulator run</span>
<span class="c1"># it makes use of the obs params &quot;f_smp_mapping&quot; as the sampling frequency</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mapping_time</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">mapping_offsets</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># this is the offsets from bore sight</span>

<span class="c1"># to evaluate mapping pattern around a coordinates, use evaluate_at</span>
<span class="c1"># The frame of input coordinates will be assumed for the offsets</span>
<span class="c1"># here the mapping target from the config is given in equitorial</span>
<span class="c1"># so the mapping will be along equitorial coordinate frame</span>
<span class="n">target_coord</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">target</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mapping target: </span><span class="si">{</span><span class="n">mapping</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">mapping_coords</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">target_coord</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="c1"># the bore sight offsets</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mapping_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">),</span>
    <span class="n">mapping_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>  <span class="c1"># the target</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;lon. offset (arcmin)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;lat. offset (arcmin)&#39;</span><span class="p">)</span>

<span class="c1"># the sky coords, which we need an fiducial wcs object</span>
<span class="c1"># to plot in the ref frame of target coords, i.e., ICRS</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">celestial_frame_to_wcs</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">celestial_frame_to_wcs</span><span class="p">(</span><span class="n">target_coord</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
<span class="c1"># set the crval to target</span>
<span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">target_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>  <span class="c1"># a WCSAxes plot, see https://docs.astropy.org/en/stable/visualization/wcsaxes/index.html</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mapping_coords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
    <span class="n">mapping_coords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">target_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">target_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ticklabel</span><span class="p">(</span><span class="n">exclude_overlapping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># reduce the cluttering of tick labels.</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[9]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapping</span> <span class="n">model</span><span class="p">:</span>
<span class="n">Model</span><span class="p">:</span> <span class="n">SkyRasterScanModel</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Parameters</span><span class="p">:</span>
    <span class="n">length</span> <span class="n">space</span>  <span class="n">n_scans</span> <span class="n">rot</span>   <span class="n">speed</span>    <span class="n">t_turnover</span>
    <span class="n">arcmin</span> <span class="n">arcsec</span>         <span class="n">deg</span> <span class="n">arcmin</span> <span class="o">/</span> <span class="n">s</span>     <span class="n">s</span>
    <span class="o">------</span> <span class="o">------</span> <span class="o">-------</span> <span class="o">---</span> <span class="o">----------</span> <span class="o">----------</span>
       <span class="mf">1.0</span>    <span class="mf">1.5</span>    <span class="mf">40.0</span> <span class="mf">0.0</span>        <span class="mf">1.0</span>        <span class="mf">0.1</span>
<span class="n">time</span> <span class="n">to</span> <span class="n">finish</span> <span class="n">mapping</span><span class="p">:</span> <span class="mf">43.9</span> <span class="n">s</span>
<span class="n">mapping</span> <span class="n">target</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">SkyCoord</span> <span class="p">(</span><span class="n">ICRS</span><span class="p">):</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">deg</span>
    <span class="p">(</span><span class="mf">92.</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">InputWarning</span><span class="p">:</span> <span class="n">Coordinate</span> <span class="n">string</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">interpreted</span> <span class="k">as</span> <span class="n">an</span> <span class="n">ICRS</span> <span class="n">coordinate</span><span class="o">.</span> <span class="p">[</span><span class="n">astroquery</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">commons</span><span class="p">]</span>
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_17_2.png" src="../_images/tolteca_reduce_17_2.png" />
<p>For the input sources, the <code class="docutils literal notranslate"><span class="pre">sources</span></code> list specified in the simulator
configs is parsed and a set of <code class="docutils literal notranslate"><span class="pre">tolteca.simu.base.SourceModel</span></code>
subclass instances are created according to the <code class="docutils literal notranslate"><span class="pre">type</span></code> key. In this
case, we only have one model with type <code class="docutils literal notranslate"><span class="pre">point_source_catalog</span></code>. It is
specified in format of an ASCII table, which we just created. Below is
the snippet that renders the input point sources to FITS image HDUs as
observed by the TolTEC instrument:</p>
<p><span class="inputnumrole">In[10]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sources</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">get_source_model</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sources: </span><span class="si">{</span><span class="n">sources</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">m_point_source</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># take out the point source model and let&#39;s take a look</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model class is:</span><span class="se">\n</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">m_point_source</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model data:</span><span class="se">\n</span><span class="si">{</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model source positions: </span><span class="si">{</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># we can make a synetic image and plot by creating a SourceImageModel from the SourceCatalogModel</span>
<span class="c1"># to do this we need some beammodels and a pixelscale.</span>
<span class="c1"># we can use the toltec beammodels here, and assume a 1&quot;/pix scale</span>
<span class="kn">from</span> <span class="nn">tolteca.simu.toltec</span> <span class="kn">import</span> <span class="n">BeamModel</span>
<span class="n">m_img</span> <span class="o">=</span> <span class="n">m_point_source</span><span class="o">.</span><span class="n">make_image_model</span><span class="p">(</span><span class="n">beam_models</span><span class="o">=</span><span class="n">BeamModel</span><span class="p">()</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">pixscale</span><span class="o">=</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
<span class="c1"># the m_img is a SourceImageModel class which contains image data as a dict of ImageHDU.</span>
<span class="c1"># we create a set of WCSAxes to plot them</span>

<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">n_hdus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hdu</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_hdus</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># label the sources</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">m_point_source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[10]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sources: [&lt;SourceCatalogModel(name=&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/toltec_sources.asc&#39;)&gt;, {&#39;a1100&#39;: &lt;ArrayLoadingModel(name=&#39;a1100_loading&#39;)&gt;, &#39;a1400&#39;: &lt;ArrayLoadingModel(name=&#39;a1400_loading&#39;)&gt;, &#39;a2000&#39;: &lt;ArrayLoadingModel(name=&#39;a2000_loading&#39;)&gt;}]
model class is:
&lt;class &#39;tolteca.simu.base.SourceCatalogModel&#39;&gt;
Name: SourceCatalogModel
N_inputs: 2
N_outputs: 1
model data:
a1100 a1400 a2000  dec  name   ra
 mJy   mJy   mJy   deg        deg
----- ----- ----- ----- ---- -----
 30.0  20.0  10.0  -7.0   s0  92.0
 10.0  10.0  10.0 -7.01   s1  92.0
100.0 200.0 300.0  -7.0   s3 92.01
model source positions: &lt;SkyCoord (ICRS): (ra, dec) in deg
    [(92.  , -7.  ), (92.  , -7.01), (92.01, -7.  )]&gt;
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_19_1.png" src="../_images/tolteca_reduce_19_1.png" />
<p>The last piece of the simulator, namely, the <code class="docutils literal notranslate"><span class="pre">instrument</span></code>, ties the
mapping model and the source models together, and drives generating of
simulated data.</p>
<p>Under the hood, <code class="docutils literal notranslate"><span class="pre">tolteca.simu.base.SimulatorBase</span></code> defines the abstract
interface for implementing the simulator engine. Subclasses are
implemented to make simulated observations for different instruments.</p>
<p>We have specified <code class="docutils literal notranslate"><span class="pre">instrument:</span> <span class="pre">toltec</span></code> in the simulator config, which
instructs the simulator runtime context to create a
<code class="docutils literal notranslate"><span class="pre">tolteca.simu.toltec.ToltecObsSimulator</span></code> instance as the simulator
engine, which implements the actual methods for createing the simulated
observations.</p>
<p>We can inspect the simulator engine as follows:</p>
<p><span class="inputnumrole">In[11]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">simobj</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">get_instrument_simulator</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;simulator engine: </span><span class="si">{</span><span class="n">simobj</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># one of the key attributes of the TolTEC simulator is the so called array property table,</span>
<span class="c1"># which stores all the detector properties as tabular data</span>
<span class="n">apt</span> <span class="o">=</span> <span class="n">simobj</span><span class="o">.</span><span class="n">table</span>
<span class="c1"># print(pformat_yaml(apt.meta))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apt</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[11]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">simulator</span> <span class="n">engine</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="o">.</span><span class="n">toltec</span><span class="o">.</span><span class="n">ToltecObsSimulator</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x121106ee0</span><span class="o">&gt;</span>
   <span class="n">uid</span>      <span class="n">nw</span>  <span class="n">pg</span> <span class="o">...</span>         <span class="n">x_t</span>                   <span class="n">y_t</span>
                   <span class="o">...</span>         <span class="n">deg</span>                   <span class="n">deg</span>
<span class="o">----------</span> <span class="o">---</span> <span class="o">---</span> <span class="o">...</span> <span class="o">--------------------</span> <span class="o">----------------------</span>
<span class="mi">00_0_169_0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span>   <span class="o">-</span><span class="mf">0.01154409322948823</span>
<span class="mi">00_0_169_1</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span>   <span class="o">-</span><span class="mf">0.01154409322948823</span>
<span class="mi">00_1_170_0</span>   <span class="mi">0</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span>  <span class="o">-</span><span class="mf">0.010101081575802202</span>
<span class="mi">00_1_170_1</span>   <span class="mi">0</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span>  <span class="o">-</span><span class="mf">0.010101081575802202</span>
<span class="mi">00_0_163_0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span>  <span class="o">-</span><span class="mf">0.008658069922116172</span>
<span class="mi">00_0_163_1</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span>  <span class="o">-</span><span class="mf">0.008658069922116172</span>
<span class="mi">00_1_159_0</span>   <span class="mi">0</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span> <span class="o">-</span><span class="mf">0.0072150582684301435</span>
<span class="mi">00_1_159_1</span>   <span class="mi">0</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span> <span class="o">-</span><span class="mf">0.0072150582684301435</span>
<span class="mi">00_0_155_0</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span> <span class="o">-</span><span class="mf">0.0057720466147441135</span>
<span class="mi">00_0_155_1</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03249180330681757</span> <span class="o">-</span><span class="mf">0.0057720466147441135</span>
       <span class="o">...</span> <span class="o">...</span> <span class="o">...</span> <span class="o">...</span>                  <span class="o">...</span>                    <span class="o">...</span>
<span class="mi">12_0_156_0</span>  <span class="mi">12</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="mf">0.0038567766016699306</span>
<span class="mi">12_0_156_1</span>  <span class="mi">12</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="mf">0.0038567766016699306</span>
<span class="mi">12_1_154_0</span>  <span class="mi">12</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="mf">0.0012855922005566422</span>
<span class="mi">12_1_154_1</span>  <span class="mi">12</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="mf">0.0012855922005566422</span>
<span class="mi">12_0_155_0</span>  <span class="mi">12</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="o">-</span><span class="mf">0.001285592200556646</span>
<span class="mi">12_0_155_1</span>  <span class="mi">12</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="o">-</span><span class="mf">0.001285592200556646</span>
<span class="mi">12_1_155_0</span>  <span class="mi">12</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="o">-</span><span class="mf">0.003856776601669935</span>
<span class="mi">12_1_155_1</span>  <span class="mi">12</span>   <span class="mi">1</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="o">-</span><span class="mf">0.003856776601669935</span>
<span class="mi">12_0_158_0</span>  <span class="mi">12</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="o">-</span><span class="mf">0.006427961002783224</span>
<span class="mi">12_0_158_1</span>  <span class="mi">12</span>   <span class="mi">0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">0.03445012806505416</span>  <span class="o">-</span><span class="mf">0.006427961002783224</span>
<span class="n">Length</span> <span class="o">=</span> <span class="mi">7718</span> <span class="n">rows</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[12]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the columns x_t and y_t (`t` stands for toltec) stores the location of each</span>
<span class="c1"># detector on the focal plane, offseted from a fiducial center (co-axial for all three arrays)</span>
<span class="c1"># to plot the focal plane for each array.</span>
<span class="n">apt_grps</span> <span class="o">=</span> <span class="n">apt</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;array_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
<span class="n">n_arrays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">apt_grps</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_arrays</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="c1"># color map kwargs</span>
<span class="n">n_networks</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">cm_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab20&#39;</span><span class="p">,</span> <span class="n">n_networks</span><span class="p">),</span>
    <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">n_networks</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="p">),</span> <span class="n">subapt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">apt_grps</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">apt_grps</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="c1"># color code by each detector &quot;network&quot; and toltec has 13 of them</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subapt</span><span class="p">[</span><span class="s1">&#39;x_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">),</span> <span class="n">subapt</span><span class="p">[</span><span class="s1">&#39;y_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">subapt</span><span class="p">[</span><span class="s1">&#39;nw&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">cm_kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">apt</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">array_name</span><span class="p">][</span><span class="s1">&#39;name_long&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;lon offset (arcmin)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;lat offset (arcmin)&#39;</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.87</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;network id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[12]:</span></p>
<img alt="../_images/tolteca_reduce_22_0.png" src="../_images/tolteca_reduce_22_0.png" />
<p>The default array property table also include a set of fiducial KIDs
model parameters. These KIDs model parameters are used to create the
KIDs resonator model as well as to simulate the readout circuit. These
aspects can be inspected via the <code class="docutils literal notranslate"><span class="pre">kidssim</span></code> and <code class="docutils literal notranslate"><span class="pre">kids_readout_model</span></code>
properties:</p>
<p><span class="inputnumrole">In[13]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kidssim</span> <span class="o">=</span> <span class="n">simobj</span><span class="o">.</span><span class="n">kidssim</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kidssim</span><span class="p">)</span>
<span class="c1"># plot the resonance circle by simulating a sweep</span>
<span class="n">x</span><span class="p">,</span> <span class="n">S21</span> <span class="o">=</span> <span class="n">kidssim</span><span class="o">.</span><span class="n">sweep_x</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="mi">176</span><span class="p">,</span> <span class="n">n_fwhms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sweep data x shape: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> S21 shape: </span><span class="si">{</span><span class="n">S21</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># plot the first detectors</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1"># f-S21 plane</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">S21</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;detuning paramter x&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;normalized S21&#39;</span><span class="p">)</span>
<span class="c1"># I-Q plane</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">S21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">S21</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;In-phase normalized&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Quatrature normalized&#39;</span><span class="p">)</span>
<span class="c1"># the kids readout model mix the normalized S21 with the readout circuit signatures.</span>
<span class="c1"># in the kids model we use here, this is just a gain factor but in the actual TolTEC readout</span>
<span class="c1"># system, the readout model is much more complicated</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="c1"># note the readout model need additionally the actual readout frequencies as the inputs</span>
<span class="c1"># we compute f from the x values following the definition of x := f/fr - 1</span>
<span class="n">S21_readout</span> <span class="o">=</span> <span class="n">simobj</span><span class="o">.</span><span class="n">kids_readout_model</span><span class="p">(</span><span class="n">S21</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">kidssim</span><span class="o">.</span><span class="n">fr</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
<span class="c1"># note on the plot below how the value range is different</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;In-phase with readout gain (adu)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Quatrature with readout gain (adu)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">S21_readout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">S21_readout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[13]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">kidsproc</span><span class="o">.</span><span class="n">kidsmodel</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">KidsSimulator</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x133a7d850</span><span class="o">&gt;</span>
<span class="n">sweep</span> <span class="n">data</span> <span class="n">x</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">7718</span><span class="p">,</span> <span class="mi">176</span><span class="p">)</span> <span class="n">S21</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">7718</span><span class="p">,</span> <span class="mi">176</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span> <span class="n">at</span> <span class="mh">0x1334ac2b0</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_24_2.png" src="../_images/tolteca_reduce_24_2.png" />
<p>The routine that puts all the pieces together are methods
<code class="docutils literal notranslate"><span class="pre">mapping_context</span></code> and <code class="docutils literal notranslate"><span class="pre">probe_context</span></code>. It does the actual compuation
for given source model and mapping pattern. Below we demonstrate some of
the internals of these methods:</p>
<p><span class="inputnumrole">In[14]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">simobj</span><span class="o">.</span><span class="n">mapping_context</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">mapping</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">)</span> <span class="k">as</span> <span class="n">mapping_evaluator</span><span class="p">:</span>
    <span class="c1"># obs is a callable that takes time delta, and produces the time ordered data sampled from the sources</span>
    <span class="c1"># with the mapping pattern</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mapping evaluator: </span><span class="si">{</span><span class="n">mapping_evaluator</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># for example, we can evaluate the time ordered data for the first 5 seconds, with some fiducial</span>
    <span class="c1"># sampling rate 122Hz</span>
    <span class="n">f_smp</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">f_smp</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">obs_info</span> <span class="o">=</span> <span class="n">mapping_evaluator</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;signal shape: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, unit: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;obs_info keys: </span><span class="si">{</span><span class="n">obs_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># we can plot some of the TODs on sky with the help of obs info</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;a1100&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="c1"># plot the rendered source image in 1.1mm</span>
<span class="c1"># ax.set_aspect(&#39;equal&#39;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">obs_info</span><span class="p">[</span><span class="s1">&#39;obs_coords_icrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs_info</span><span class="p">[</span><span class="s1">&#39;obs_coords_icrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bore sight&#39;</span><span class="p">)</span>
<span class="c1"># di=2474 is one of the detector that saw the sources</span>
<span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2474</span><span class="p">,</span> <span class="mi">3500</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">obs_info</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:,</span> <span class="n">di</span><span class="p">],</span> <span class="n">obs_info</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:,</span> <span class="n">di</span><span class="p">],</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;detector #</span><span class="si">{</span><span class="n">di</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[14]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapping</span> <span class="n">evaluator</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">ToltecObsSimulator</span><span class="o">.</span><span class="n">mapping_context</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">evaluate</span> <span class="n">at</span> <span class="mh">0x133254700</span><span class="o">&gt;</span>
<span class="n">signal</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">7718</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">unit</span><span class="p">:</span> <span class="n">MJy</span> <span class="o">/</span> <span class="n">sr</span>
<span class="n">obs_info</span> <span class="n">keys</span><span class="p">:</span> <span class="n">dict_keys</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;time_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;_ref_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;_ref_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_flags&#39;</span><span class="p">,</span> <span class="s1">&#39;m_proj_icrs&#39;</span><span class="p">,</span> <span class="s1">&#39;m_proj_native&#39;</span><span class="p">,</span> <span class="s1">&#39;projected_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;native_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_coords_icrs&#39;</span><span class="p">,</span> <span class="s1">&#39;_altaz_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_coords_altaz&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_parallactic_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;m_rot_m3&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="s1">&#39;s_additive&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;m_source&#39;</span><span class="p">,</span> <span class="s1">&#39;mapping&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="s1">&#39;tbl&#39;</span><span class="p">,</span> <span class="s1">&#39;x_t&#39;</span><span class="p">,</span> <span class="s1">&#39;y_t&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x1354f3820</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_26_2.png" src="../_images/tolteca_reduce_26_2.png" />
<p><span class="inputnumrole">In[15]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the probe context returns the kidsdata evaluator, which</span>
<span class="c1"># takes the sky signal as input and produce readout timestream</span>
<span class="k">with</span> <span class="n">simobj</span><span class="o">.</span><span class="n">probe_context</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">kidsdata_evaluator</span><span class="p">:</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">S21</span><span class="p">,</span> <span class="n">probe_info</span> <span class="o">=</span> <span class="n">kidsdata_evaluator</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;S21 shape: </span><span class="si">{</span><span class="n">S21</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> dtype: </span><span class="si">{</span><span class="n">S21</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># It may be interesting to look at the PSD of the measured time streams</span>
<span class="c1"># note that we didn&#39;t include any noise so the PSDs will be zero</span>
<span class="c1"># for detector that didn&#39;t pass the point sources</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>

<span class="n">psds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">psd_f</span><span class="p">,</span> <span class="n">psds</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">f_smp</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">psds</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f_smp</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">))</span>
<span class="n">_</span><span class="p">,</span> <span class="n">psds</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">S21</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">f_smp</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">))</span>
<span class="n">_</span><span class="p">,</span> <span class="n">psds</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">S21</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">f_smp</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;PSD Frequency (Hz)&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">psd</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">psds</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PSD </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># di=2474 is one of the detector that saw the sources.</span>
    <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2474</span><span class="p">,</span> <span class="mi">3500</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psd_f</span><span class="p">,</span> <span class="n">psd</span><span class="p">[</span><span class="n">di</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;detector </span><span class="si">{</span><span class="n">di</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[15]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">S21</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">7718</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">complex128</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">Legend</span> <span class="n">at</span> <span class="mh">0x135ddbdf0</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_27_2.png" src="../_images/tolteca_reduce_27_2.png" />
<p>To simulator an entire observation and save the data to data file,
<code class="docutils literal notranslate"><span class="pre">tolteca.simu</span></code> provides a convenient interface
<code class="docutils literal notranslate"><span class="pre">SimulatorRuntime.run</span></code>. The method implement the end-to-end work flow
that ties the mapping pattern, the source models, the instrument
simulator engine, as well as the data output module.</p>
<p><span class="inputnumrole">In[16]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[16]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">InputWarning</span><span class="p">:</span> <span class="n">Coordinate</span> <span class="n">string</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">interpreted</span> <span class="k">as</span> <span class="n">an</span> <span class="n">ICRS</span> <span class="n">coordinate</span><span class="o">.</span> <span class="p">[</span><span class="n">astroquery</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">commons</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SimulatorResult</span><span class="p">(</span><span class="n">_iterdata</span><span class="o">=&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">SimulatorRuntime</span><span class="o">.</span><span class="n">run</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">data_generator</span> <span class="n">at</span> <span class="mh">0x13333e270</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">_lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;my_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;boo&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="s1">&#39;2021-06-19T03:18:35.245&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1.dev323+g1c6dc6b&#39;</span><span class="p">},</span> <span class="s1">&#39;simu&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;jobkey&#39;</span><span class="p">:</span> <span class="s1">&#39;toltec_point_source&#39;</span><span class="p">,</span> <span class="s1">&#39;sources&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;filepath&#39;</span><span class="p">:</span> <span class="s1">&#39;toltec_sources.asc&#39;</span><span class="p">,</span> <span class="s1">&#39;grouping&#39;</span><span class="p">:</span> <span class="s1">&#39;array_name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;point_source_catalog&#39;</span><span class="p">,</span> <span class="s1">&#39;colname_map&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;a1100&#39;</span><span class="p">:</span> <span class="s1">&#39;flux_a1100&#39;</span><span class="p">,</span> <span class="s1">&#39;a1400&#39;</span><span class="p">:</span> <span class="s1">&#39;flux_a1400&#39;</span><span class="p">,</span> <span class="s1">&#39;a2000&#39;</span><span class="p">:</span> <span class="s1">&#39;flux_a2000&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">:</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="s1">&#39;ra&#39;</span><span class="p">}},</span> <span class="p">{</span><span class="s1">&#39;atm_model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;am_q50&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;toltec_array_loading&#39;</span><span class="p">}],</span> <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;calobj&#39;</span><span class="p">:</span> <span class="s1">&#39;cal/calobj_default/index.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;toltec&#39;</span><span class="p">},</span> <span class="s1">&#39;mapping&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="s1">&#39;1. arcmin&#39;</span><span class="p">,</span> <span class="s1">&#39;n_scans&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;ref_frame&#39;</span><span class="p">:</span> <span class="s1">&#39;icrs&#39;</span><span class="p">,</span> <span class="s1">&#39;rot&#39;</span><span class="p">:</span> <span class="s1">&#39;0. deg&#39;</span><span class="p">,</span> <span class="s1">&#39;space&#39;</span><span class="p">:</span> <span class="s1">&#39;1.5 arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;speed&#39;</span><span class="p">:</span> <span class="s1">&#39;1. arcmin/s&#39;</span><span class="p">,</span> <span class="s1">&#39;t0&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;t_turnover&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1 s&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;92d -7d&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;tolteca.simu:SkyRasterScanModel&#39;</span><span class="p">},</span> <span class="s1">&#39;obs_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f_smp_data&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">122.</span> <span class="n">Hz</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;f_smp_mapping&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">12.</span> <span class="n">Hz</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;t_exp&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">1.</span> <span class="n">ct</span><span class="o">&gt;</span><span class="p">},</span> <span class="s1">&#39;mapping_only&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;perf_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;chunk_size&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">10.</span> <span class="n">s</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;mapping_interp_len&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">1.</span> <span class="n">s</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;erfa_interp_len&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">300.</span> <span class="n">s</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;anim_frame_rate&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">12.</span> <span class="n">Hz</span><span class="o">&gt;</span><span class="p">},</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="s1">&#39;runtime&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;rootpath&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk&#39;</span><span class="p">),</span> <span class="s1">&#39;bindir&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/bin&#39;</span><span class="p">),</span> <span class="s1">&#39;caldir&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/cal&#39;</span><span class="p">),</span> <span class="s1">&#39;logdir&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/log&#39;</span><span class="p">),</span> <span class="s1">&#39;setup_file&#39;</span><span class="p">:</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/50_setup.yaml&#39;</span><span class="p">)}},</span> <span class="n">data_generator</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">SimulatorRuntime</span><span class="o">.</span><span class="n">run</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">data_generator</span> <span class="n">at</span> <span class="mh">0x135e60d30</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=&lt;</span><span class="n">SkyRasterScanModel</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mf">1.</span> <span class="n">arcmin</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="mf">1.5</span> <span class="n">arcsec</span><span class="p">,</span> <span class="n">n_scans</span><span class="o">=</span><span class="mf">40.</span> <span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mf">0.</span> <span class="n">deg</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">1.</span> <span class="n">arcmin</span> <span class="o">/</span> <span class="n">s</span><span class="p">,</span> <span class="n">t_turnover</span><span class="o">=</span><span class="mf">0.1</span> <span class="n">s</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">obs_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;f_smp_data&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">122.</span> <span class="n">Hz</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;f_smp_mapping&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">12.</span> <span class="n">Hz</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;t_exp&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Quantity</span> <span class="mf">1.</span> <span class="n">ct</span><span class="o">&gt;</span><span class="p">},</span> <span class="n">simctx</span><span class="o">=</span><span class="n">SimulatorRuntime</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="p">),</span> <span class="n">simobj</span><span class="o">=&lt;</span><span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="o">.</span><span class="n">toltec</span><span class="o">.</span><span class="n">ToltecObsSimulator</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x13328ff10</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="o">&lt;</span><span class="n">SourceCatalogModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/toltec_sources.asc&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a1100&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ArrayLoadingModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a1100_loading&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;a1400&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ArrayLoadingModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a1400_loading&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;a2000&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ArrayLoadingModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a2000_loading&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">}])</span>
</pre></div>
</div>
<p>The above line creates the <code class="docutils literal notranslate"><span class="pre">tolteca.simu.SimulatorResult</span></code> instance
which holds the result. The result can be marked as either <code class="docutils literal notranslate"><span class="pre">lazy</span></code> or
not. In the lazy case (our case, as indicated by the <code class="docutils literal notranslate"><span class="pre">lazy</span></code>
attribute), the actual simulation is run when the
<code class="docutils literal notranslate"><span class="pre">SimulatorResult.save</span></code> method is called, and the simulation will be
run in chunks, to allow simulating a lot of data that cannot be held in
the memory at once:</p>
<p><span class="inputnumrole">In[17]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">outdir</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">get_or_create_output_dir</span><span class="p">()</span>
<span class="n">result</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;saved simulated data to </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[17]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">InputWarning</span><span class="p">:</span> <span class="n">Coordinate</span> <span class="n">string</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">interpreted</span> <span class="k">as</span> <span class="n">an</span> <span class="n">ICRS</span> <span class="n">coordinate</span><span class="o">.</span> <span class="p">[</span><span class="n">astroquery</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">commons</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">saved</span> <span class="n">simulated</span> <span class="n">data</span> <span class="n">to</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">toltec_point_source</span>
</pre></div>
</div>
<p>The files created are listed as below. The <code class="docutils literal notranslate"><span class="pre">apt_*.ecsv</span></code> is the array
property table, and the <code class="docutils literal notranslate"><span class="pre">toltec*_.nc</span></code> are the raw KIDs data:</p>
<p><span class="inputnumrole">In[18]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tollan.utils.fmt</span> <span class="kn">import</span> <span class="n">pformat_paths</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_paths</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="n">relative_to</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[18]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt_000001_000_0000_2021_06_19_03_18_45</span><span class="o">.</span><span class="n">ecsv</span>
<span class="n">simresult</span><span class="o">.</span><span class="n">state</span>
<span class="n">tel_000001_000_0000_2021_06_19_03_18_45</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec0_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec10_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec11_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec12_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec1_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec2_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec3_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec4_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec5_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec6_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec7_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec8_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">toltec9_000001_000_0000_2021_06_19_03_18_45_timestream</span><span class="o">.</span><span class="n">nc</span>
<span class="n">tolteca</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>At this poin, we’ve done creating our simulated data. It is noted that
the various inspection and plotting is for the educational purpose of
the tutorial, exposing the under-the-hood machineries.</p>
<p>For doing the simulation in production, one just need to create a
<code class="docutils literal notranslate"><span class="pre">SimulatorRuntime</span></code> object, call the <code class="docutils literal notranslate"><span class="pre">SimulatorRuntime.run</span></code> method,
finally the <code class="docutils literal notranslate"><span class="pre">SimulatorResult.save</span></code>.</p>
<p>To make it even easier, the <code class="docutils literal notranslate"><span class="pre">tolteca.cli</span></code> module provides a command
line interface to invoke the simulator work flow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd some_tolteca_workdir
$ tolteca simu
</pre></div>
</div>
</div>
<div class="section" id="reduce-the-simulated-observation">
<h2>Reduce the simulated observation<a class="headerlink" href="#reduce-the-simulated-observation" title="Permalink to this headline">¶</a></h2>
<p>The data reduction is done by using the
<code class="docutils literal notranslate"><span class="pre">tolteca.reduce.PipelineRuntime</span></code>, a subclass of the
<code class="docutils literal notranslate"><span class="pre">tolteca.utils.RuntimeContext</span></code> object that we should now already be
familar with. To create the pipeline runtime,</p>
<p><span class="inputnumrole">In[19]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tolteca.reduce</span> <span class="kn">import</span> <span class="n">PipelineRuntime</span>
<span class="n">prc</span> <span class="o">=</span> <span class="n">PipelineRuntime</span><span class="p">(</span><span class="n">rootpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created pipeline runtime </span><span class="si">{</span><span class="n">prc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">prc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">prc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[19]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">pipeline</span> <span class="n">runtime</span> <span class="n">PipelineRuntime</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/50_setup.yaml&#39;</span><span class="p">),</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/60_simu.yaml&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">SchemaMissingKeyError</span>                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">6864</span><span class="n">aabdb620</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
      <span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created pipeline runtime </span><span class="si">{</span><span class="n">prc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="mi">4</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">prc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">prc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">python</span><span class="o">@</span><span class="mf">3.8</span><span class="o">/</span><span class="mf">3.8.10</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">cached_property</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
     <span class="mi">34</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap_in_coroutine</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">35</span>
<span class="o">---&gt;</span> <span class="mi">36</span>         <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
     <span class="mi">37</span>         <span class="k">return</span> <span class="n">value</span>
     <span class="mi">38</span>


<span class="o">~/</span><span class="n">Codes</span><span class="o">/</span><span class="n">toltec</span><span class="o">/</span><span class="n">py</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">tolteca</span><span class="o">/</span><span class="n">utils</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="mi">145</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    146         if self.is_persistent:</span>
<span class="s2">--&gt; 147             cfg = self.collect_config_from_files(</span>
<span class="s2">    148                     self.config_files, validate=True</span>
<span class="s2">    149                     )</span>


<span class="s2">~/Codes/toltec/py/tollan/tollan/utils/dirconf.py in collect_config_from_files(cls, config_files, validate)</span>
<span class="s2">    143                 rupdate(cfg, c)</span>
<span class="s2">    144         if validate:</span>
<span class="s2">--&gt; 145             cfg = cls.validate_config(cfg)</span>
<span class="s2">    146         return cfg</span>
<span class="s2">    147</span>


<span class="s2">~/Codes/toltec/py/tollan/tollan/utils/dirconf.py in validate_config(cls, cfg)</span>
<span class="s2">    148     @classmethod</span>
<span class="s2">    149     def validate_config(cls, cfg):</span>
<span class="s2">--&gt; 150         return cls.get_config_schema().validate(cfg)</span>
<span class="s2">    151</span>
<span class="s2">    152     @classmethod</span>


<span class="s2">/usr/local/Cellar/python@3.8/3.8.10/envs/tolteca/lib/python3.8/site-packages/schema.py in validate(self, data)</span>
<span class="s2">    409                 message = &quot;Missing key</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot; % (_plural_s(missing_keys), s_missing_keys)</span>
<span class="s2">    410                 message = self._prepend_schema_name(message)</span>
<span class="s2">--&gt; 411                 raise SchemaMissingKeyError(message, e.format(data) if e else None)</span>
<span class="s2">    412             if not self._ignore_extra_keys and (len(new) != len(data)):</span>
<span class="s2">    413                 wrong_keys = set(data.keys()) - set(new.keys())</span>


<span class="s2">SchemaMissingKeyError: Missing key: &#39;reduce&#39;</span>
</pre></div>
</div>
<p>The reason of the exception is that we have not “setup” the pipeline
properly. The pipeline expects a branch of config entries under the key
<code class="docutils literal notranslate"><span class="pre">reduce</span></code>, stored in one of the YAML files found in the workdir.</p>
<p>The tolteca.reduce has a set of “built-in” configurations that one can
use readily, one of which is ‘toltec_point_source’. Let’s dump this
config to the workdir with file name “80_reduce.yaml”. Note the format
<code class="docutils literal notranslate"><span class="pre">\d+_.+.yaml</span></code>, this is the convention of the YAML config files to be
recongnized by the tolteca runtime context. The files with lower number
are overriden by those with higher number.</p>
<p><span class="inputnumrole">In[20]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tolteca.reduce</span> <span class="kn">import</span> <span class="n">example_configs</span> <span class="k">as</span> <span class="n">cfgs</span>
<span class="n">cfg</span> <span class="o">=</span> <span class="n">cfgs</span><span class="p">[</span><span class="s1">&#39;toltec_citlali_simple&#39;</span><span class="p">]</span>
<span class="c1"># here we need to update the input path field to match the simu outdir</span>
<span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;reduce&#39;</span><span class="p">][</span><span class="s1">&#39;inputs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;simu&#39;</span><span class="p">][</span><span class="s1">&#39;jobkey&#39;</span><span class="p">]</span>
<span class="c1"># and we set the jobkey to something more sensible</span>
<span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;reduce&#39;</span><span class="p">][</span><span class="s1">&#39;jobkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;toltec_point_source_reduced&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">rootpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;80_reduce.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fo</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[20]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reduce</span><span class="p">:</span>
  <span class="n">inputs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source_reduced</span>
  <span class="n">pipeline</span><span class="p">:</span>
    <span class="n">config</span><span class="p">:</span>
      <span class="n">kids</span><span class="p">:</span>
        <span class="n">fitter</span><span class="p">:</span>
          <span class="n">modelspec</span><span class="p">:</span> <span class="n">gainlintrend</span>
          <span class="n">weight_window</span><span class="p">:</span>
            <span class="n">fwhm_Hz</span><span class="p">:</span> <span class="mf">1.5e4</span>
            <span class="nb">type</span><span class="p">:</span> <span class="n">lorentz</span>
        <span class="n">solver</span><span class="p">:</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
        <span class="n">mgrid0</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">mgrid1</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">offset</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">pattern</span><span class="p">:</span> <span class="n">Raster</span>
        <span class="n">pixelsize</span><span class="p">:</span> <span class="mf">0.75</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">RaDec</span>
      <span class="n">runtime</span><span class="p">:</span>
        <span class="n">ncores</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">seq</span>
      <span class="n">tod</span><span class="p">:</span>
        <span class="n">despike</span><span class="p">:</span>
          <span class="n">despikewindow</span><span class="p">:</span> <span class="mi">32</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">sigma</span><span class="p">:</span> <span class="mf">8.0</span>
          <span class="n">timeconstant</span><span class="p">:</span> <span class="mf">0.015</span>
        <span class="n">downsample</span><span class="p">:</span>
          <span class="n">downsamplefactor</span><span class="p">:</span> <span class="mi">1</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
        <span class="nb">filter</span><span class="p">:</span>
          <span class="n">agibbs</span><span class="p">:</span> <span class="mf">50.0</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">fhigh</span><span class="p">:</span> <span class="mf">4.0</span>
          <span class="n">flow</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">nterms</span><span class="p">:</span> <span class="mi">32</span>
        <span class="n">kernel</span><span class="p">:</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">pcaclean</span><span class="p">:</span>
          <span class="n">approximateWeights</span><span class="p">:</span> <span class="mi">0</span>
          <span class="n">cutStd</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
          <span class="n">neigToCut</span><span class="p">:</span> <span class="mi">9</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">citlali</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[21]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># now we are ready to load the pipeline runtime:</span>
<span class="n">prc</span> <span class="o">=</span> <span class="n">PipelineRuntime</span><span class="p">(</span><span class="n">rootpath</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Created pipeline runtime </span><span class="si">{</span><span class="n">prc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config files in the rc: </span><span class="si">{</span><span class="n">prc</span><span class="o">.</span><span class="n">config_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config:</span><span class="se">\n</span><span class="si">{</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">prc</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[21]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Created</span> <span class="n">pipeline</span> <span class="n">runtime</span> <span class="n">PipelineRuntime</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="p">)</span>
<span class="n">Config</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rc</span><span class="p">:</span> <span class="p">[</span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/50_setup.yaml&#39;</span><span class="p">),</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/60_simu.yaml&#39;</span><span class="p">),</span> <span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/80_reduce.yaml&#39;</span><span class="p">)]</span>
<span class="n">Config</span><span class="p">:</span>

<span class="n">my_info</span><span class="p">:</span>
  <span class="n">foo</span><span class="p">:</span> <span class="n">bar</span>
<span class="n">reduce</span><span class="p">:</span>
  <span class="n">inputs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">path</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source_reduced</span>
  <span class="n">pipeline</span><span class="p">:</span>
    <span class="n">config</span><span class="p">:</span>
      <span class="n">kids</span><span class="p">:</span>
        <span class="n">fitter</span><span class="p">:</span>
          <span class="n">modelspec</span><span class="p">:</span> <span class="n">gainlintrend</span>
          <span class="n">weight_window</span><span class="p">:</span>
            <span class="n">fwhm_Hz</span><span class="p">:</span> <span class="mf">1.5e4</span>
            <span class="nb">type</span><span class="p">:</span> <span class="n">lorentz</span>
        <span class="n">solver</span><span class="p">:</span>
      <span class="nb">map</span><span class="p">:</span>
        <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
        <span class="n">mgrid0</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">mgrid1</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">offset</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="n">pattern</span><span class="p">:</span> <span class="n">Raster</span>
        <span class="n">pixelsize</span><span class="p">:</span> <span class="mf">0.75</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">RaDec</span>
      <span class="n">runtime</span><span class="p">:</span>
        <span class="n">ncores</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">seq</span>
      <span class="n">tod</span><span class="p">:</span>
        <span class="n">despike</span><span class="p">:</span>
          <span class="n">despikewindow</span><span class="p">:</span> <span class="mi">32</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">sigma</span><span class="p">:</span> <span class="mf">8.0</span>
          <span class="n">timeconstant</span><span class="p">:</span> <span class="mf">0.015</span>
        <span class="n">downsample</span><span class="p">:</span>
          <span class="n">downsamplefactor</span><span class="p">:</span> <span class="mi">1</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
        <span class="nb">filter</span><span class="p">:</span>
          <span class="n">agibbs</span><span class="p">:</span> <span class="mf">50.0</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">fhigh</span><span class="p">:</span> <span class="mf">4.0</span>
          <span class="n">flow</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">nterms</span><span class="p">:</span> <span class="mi">32</span>
        <span class="n">kernel</span><span class="p">:</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">pcaclean</span><span class="p">:</span>
          <span class="n">approximateWeights</span><span class="p">:</span> <span class="mi">0</span>
          <span class="n">cutStd</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
          <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
          <span class="n">neigToCut</span><span class="p">:</span> <span class="mi">9</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">citlali</span>
  <span class="n">select</span><span class="p">:</span>
<span class="n">runtime</span><span class="p">:</span>
  <span class="n">bindir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="nb">bin</span>
  <span class="n">caldir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">cal</span>
  <span class="n">logdir</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="n">log</span>
  <span class="n">rootpath</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span>
  <span class="n">setup_file</span><span class="p">:</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="mi">50</span><span class="n">_setup</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">setup</span><span class="p">:</span>
  <span class="n">baz</span><span class="p">:</span> <span class="n">boo</span>
  <span class="n">created_at</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span><span class="n">T03</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mf">35.245</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="n">dev323</span><span class="o">+</span><span class="n">g1c6dc6b</span>
<span class="n">simu</span><span class="p">:</span>
  <span class="n">instrument</span><span class="p">:</span>
    <span class="n">calobj</span><span class="p">:</span> <span class="n">cal</span><span class="o">/</span><span class="n">calobj_default</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">yaml</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">toltec</span>
  <span class="n">jobkey</span><span class="p">:</span> <span class="n">toltec_point_source</span>
  <span class="n">mapping</span><span class="p">:</span>
    <span class="n">length</span><span class="p">:</span> <span class="s1">&#39;1. arcmin&#39;</span>
    <span class="n">n_scans</span><span class="p">:</span> <span class="mi">40</span>
    <span class="n">ref_frame</span><span class="p">:</span> <span class="n">icrs</span>
    <span class="n">rot</span><span class="p">:</span> <span class="s1">&#39;0. deg&#39;</span>
    <span class="n">space</span><span class="p">:</span> <span class="s1">&#39;1.5 arcsec&#39;</span>
    <span class="n">speed</span><span class="p">:</span> <span class="s1">&#39;1. arcmin/s&#39;</span>
    <span class="n">t0</span><span class="p">:</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">t_turnover</span><span class="p">:</span> <span class="s1">&#39;0.1 s&#39;</span>
    <span class="n">target</span><span class="p">:</span> <span class="s1">&#39;92d -7d&#39;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">tolteca</span><span class="o">.</span><span class="n">simu</span><span class="p">:</span><span class="n">SkyRasterScanModel</span>
  <span class="n">obs_params</span><span class="p">:</span>
    <span class="n">f_smp_data</span><span class="p">:</span> <span class="s1">&#39;122. Hz&#39;</span>
    <span class="n">f_smp_mapping</span><span class="p">:</span> <span class="s1">&#39;12 Hz&#39;</span>
    <span class="n">t_exp</span><span class="p">:</span> <span class="s1">&#39;1 ct&#39;</span>
  <span class="n">sources</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">colname_map</span><span class="p">:</span>
        <span class="n">a1100</span><span class="p">:</span> <span class="n">flux_a1100</span>
        <span class="n">a1400</span><span class="p">:</span> <span class="n">flux_a1400</span>
        <span class="n">a2000</span><span class="p">:</span> <span class="n">flux_a2000</span>
        <span class="n">dec</span><span class="p">:</span> <span class="n">dec</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">name</span>
        <span class="n">ra</span><span class="p">:</span> <span class="n">ra</span>
      <span class="n">filepath</span><span class="p">:</span> <span class="n">toltec_sources</span><span class="o">.</span><span class="n">asc</span>
      <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">point_source_catalog</span>
    <span class="o">-</span> <span class="n">atm_model_name</span><span class="p">:</span> <span class="n">am_q50</span>
      <span class="nb">type</span><span class="p">:</span> <span class="n">toltec_array_loading</span>
</pre></div>
</div>
<p>The pipeline runtime handles the execution of the underlying pipeline
engine, which is specified to be <code class="docutils literal notranslate"><span class="pre">citlali</span></code> in our case. To proceed, we
need to make available the citlali executable to the tolteca. This can
be conveniently done with the helper function
<code class="docutils literal notranslate"><span class="pre">RuntimeContext.link_to_bindir</span></code>:</p>
<p>We can inspect the configurations and the engine itself as follows:</p>
<p><span class="inputnumrole">In[22]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In the environment this tutorial gets rendered, we the compiled citlali</span>
<span class="c1"># executable is in ~/Codes/toltec/cpp/citlali/build/bin</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">citlali_exec</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;~/Codes/toltec/cpp/citlali/build/bin/citlali&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">prc</span><span class="o">.</span><span class="n">symlink_to_bindir</span><span class="p">(</span><span class="n">citlali_exec</span><span class="p">,</span> <span class="n">link_name</span><span class="o">=</span><span class="s1">&#39;citlali&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[22]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PosixPath</span><span class="p">(</span><span class="s1">&#39;/private/var/folders/zc/33kgh8vx3z37kpp6xf84bzvm0000gn/T/tmp7zys6eqk/bin/citlali&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[23]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ppl_params</span> <span class="o">=</span> <span class="n">prc</span><span class="o">.</span><span class="n">get_pipeline_params</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_yaml</span><span class="p">(</span><span class="n">ppl_params</span><span class="p">))</span>
<span class="c1"># we can inspect the engine version</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">ppl_params</span><span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;engine version: </span><span class="si">{</span><span class="n">engine</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[23]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">:</span>
  <span class="n">kids</span><span class="p">:</span>
    <span class="n">fitter</span><span class="p">:</span>
      <span class="n">modelspec</span><span class="p">:</span> <span class="n">gainlintrend</span>
      <span class="n">weight_window</span><span class="p">:</span>
        <span class="n">fwhm_Hz</span><span class="p">:</span> <span class="mf">1.5e4</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">lorentz</span>
    <span class="n">solver</span><span class="p">:</span>
  <span class="nb">map</span><span class="p">:</span>
    <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
    <span class="n">mgrid0</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="n">mgrid1</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="n">offset</span><span class="p">:</span> <span class="mf">0.0</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="n">Raster</span>
    <span class="n">pixelsize</span><span class="p">:</span> <span class="mf">0.75</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">RaDec</span>
  <span class="n">runtime</span><span class="p">:</span>
    <span class="n">ncores</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">policy</span><span class="p">:</span> <span class="n">seq</span>
  <span class="n">tod</span><span class="p">:</span>
    <span class="n">despike</span><span class="p">:</span>
      <span class="n">despikewindow</span><span class="p">:</span> <span class="mi">32</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">sigma</span><span class="p">:</span> <span class="mf">8.0</span>
      <span class="n">timeconstant</span><span class="p">:</span> <span class="mf">0.015</span>
    <span class="n">downsample</span><span class="p">:</span>
      <span class="n">downsamplefactor</span><span class="p">:</span> <span class="mi">1</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="nb">filter</span><span class="p">:</span>
      <span class="n">agibbs</span><span class="p">:</span> <span class="mf">50.0</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">fhigh</span><span class="p">:</span> <span class="mf">4.0</span>
      <span class="n">flow</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">nterms</span><span class="p">:</span> <span class="mi">32</span>
    <span class="n">kernel</span><span class="p">:</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">pcaclean</span><span class="p">:</span>
      <span class="n">approximateWeights</span><span class="p">:</span> <span class="mi">0</span>
      <span class="n">cutStd</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">grouping</span><span class="p">:</span> <span class="n">array_name</span>
      <span class="n">neigToCut</span><span class="p">:</span> <span class="mi">9</span>
<span class="n">engine</span><span class="p">:</span> <span class="n">Citlali</span><span class="p">(</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">zc</span><span class="o">/</span><span class="mi">33</span><span class="n">kgh8vx3z37kpp6xf84bzvm0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">tmp7zys6eqk</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">citlali</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="n">cc27f77</span><span class="p">)</span>
<span class="n">name</span><span class="p">:</span> <span class="n">citlali</span>

<span class="n">engine</span> <span class="n">version</span><span class="p">:</span> <span class="n">cc27f77</span>
</pre></div>
</div>
<p>To run the pipelin, simply do:</p>
<p><span class="inputnumrole">In[24]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">prc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[24]:</span></p>
<pre class="literal-block"><a class="reference external" href="mailto:/usr/local/Cellar/python&#37;&#52;&#48;3&#46;8/3&#46;8&#46;10/Frameworks/Python&#46;framework/Versions/3&#46;8/lib/python3&#46;8/subprocess&#46;py">/usr/local/Cellar/python<span>&#64;</span>3<span>&#46;</span>8/3<span>&#46;</span>8<span>&#46;</span>10/Frameworks/Python<span>&#46;</span>framework/Versions/3<span>&#46;</span>8/lib/python3<span>&#46;</span>8/subprocess<span>&#46;</span>py</a>:848: RuntimeWarning: line buffering (buffering=1) isn't supported in binary mode, the default buffer size will be used
  self.stdout = io.open(c2pread, 'rb', bufsize)
** logging ** configured with level=debug (debug at compile time; available levels: {trace, debug, info, warning, error, critical, off})
[2021-06-18 23:19:50.789] [info] [logging.h:129] <strong>timeit</strong> Citlali Process
[2021-06-18 23:19:50.790] [info] [main.cpp:81] reconfigure logger to level=error</pre>
<p>The files created are listed as below. The <code class="docutils literal notranslate"><span class="pre">citlali.ecsv</span></code> is the low
level config file supplied to the citlali call, and the
<code class="docutils literal notranslate"><span class="pre">toltec*_.fits</span></code> are the reduced maps.</p>
<p><span class="inputnumrole">In[25]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">outdir</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pformat_paths</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span> <span class="n">relative_to</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[25]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">citlali</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">toltec_simu_a1100_science_000001_451131</span><span class="o">.</span><span class="n">fits</span>
<span class="n">toltec_simu_a1400_science_000001_451131</span><span class="o">.</span><span class="n">fits</span>
<span class="n">toltec_simu_a2000_science_000001_451131</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
<p>We can now load back the reduced files and see the sources that we
initialy put into the simulation.</p>
<p><span class="inputnumrole">In[26]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">PercentileInterval</span><span class="p">,</span> <span class="n">ImageNormalize</span><span class="p">,</span> <span class="n">MinMaxInterval</span>
<span class="n">interval</span> <span class="o">=</span> <span class="n">PercentileInterval</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">n_hdus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">hdu</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_hdus</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># label the sources</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">m_point_source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="c1"># load the output fits file and plot</span>
    <span class="n">hl</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_*.fits&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;reduced signal&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;coverage&#39;</span><span class="p">])):</span>  <span class="c1"># signal (1), weight (2), and int 4</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">hl</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>  <span class="c1"># signal map is extension 1</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_hdus</span><span class="p">,</span> <span class="n">n_hdus</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[26]:</span></p>
<img alt="../_images/tolteca_reduce_48_0.png" src="../_images/tolteca_reduce_48_0.png" />
<p>The reduced fits images are not scaled for this current version. To
compare the photometry, we would need to get the array property table
generated along with the simulation.</p>
<p><span class="inputnumrole">In[27]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># note the [0-9] in the glob pattern. this is to not select the _trimmed.ecsv file that are used internally</span>
<span class="c1"># by the tolteca.reduce and citlali</span>
<span class="n">apt</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">get_or_create_output_dir</span><span class="p">()</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;apt_000001_*[0-9].ecsv&#39;</span><span class="p">))),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<span class="c1"># print(apt[&#39;flxscale&#39;])</span>
<span class="c1"># we can apply the flxscale to the signal images and try do the photometry</span>

<span class="kn">from</span> <span class="nn">photutils.psf</span> <span class="kn">import</span> <span class="n">DAOGroup</span>
<span class="kn">from</span> <span class="nn">photutils.psf</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">IntegratedGaussianPRF</span><span class="p">,</span>
            <span class="n">BasicPSFPhotometry</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">MMMBackground</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.fitting</span> <span class="kn">import</span> <span class="n">LevMarLSQFitter</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">SigmaClip</span>
<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">Background2D</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.functional_models</span> <span class="kn">import</span> <span class="n">GAUSSIAN_SIGMA_TO_FWHM</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span>

<span class="c1"># %matplotlib widget</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;a1100&#39;</span><span class="p">,</span> <span class="s1">&#39;a1400&#39;</span><span class="p">,</span> <span class="s1">&#39;a2000&#39;</span><span class="p">]):</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">apt</span><span class="p">[</span><span class="s1">&#39;flxscale&#39;</span><span class="p">][</span><span class="n">apt</span><span class="p">[</span><span class="s1">&#39;array_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># in this version the flxscale is shared acorss each array so we just take first one.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flxscale for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">scale</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">hl</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_*.fits&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># hl.info()</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">hl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># signal</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>  <span class="c1"># used this to get xy from source position</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="c1"># we can find some of the array facts in the beam model</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">BeamModel</span><span class="p">()</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">x_fwhm</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;beam fwhm: </span><span class="si">{</span><span class="n">fwhm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pixscale</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">pixel_scale</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">proj_plane_pixel_scales</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
    <span class="n">fwhm_pix</span> <span class="o">=</span> <span class="n">fwhm</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">pixscale</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;beam fwhm_pix: </span><span class="si">{</span><span class="n">fwhm_pix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># source catalog</span>
    <span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">m_point_source</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_0&#39;</span><span class="p">,</span> <span class="s1">&#39;y_0&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">])</span>
    <span class="c1"># print(xy)</span>

    <span class="c1"># Plot an overlay on the source</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">)),</span> <span class="n">r</span><span class="o">=</span><span class="n">fwhm_pix</span><span class="p">)</span>
    <span class="n">apertures</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff4400&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># scale the data and do PSF photometry to check the recovered flux</span>
    <span class="c1"># the scale will put data in MJy/sr and</span>
    <span class="c1"># here we convert to mJy/beam, so the photometry will recover the flux in mJy</span>
    <span class="n">beam_area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">/</span> <span class="n">GAUSSIAN_SIGMA_TO_FWHM</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">arcsec_per_pix</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">pixscale</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">arcsec_per_pix</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># .to_value(u.mJy/u.beam, equivalencies=u.beam_angular_area(beam_area))</span>

    <span class="n">psf_model</span> <span class="o">=</span> <span class="n">IntegratedGaussianPRF</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">fwhm_pix</span> <span class="o">/</span> <span class="n">GAUSSIAN_SIGMA_TO_FWHM</span><span class="p">)</span>
    <span class="n">daogroup</span> <span class="o">=</span> <span class="n">DAOGroup</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 1 pix. this will not group the sources separated larger then 1 pix</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>
    <span class="n">fit_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fwhm_pix</span> <span class="o">*</span> <span class="mf">3.</span><span class="p">)</span>  <span class="c1"># fit box of 3 * fwhm</span>
    <span class="k">if</span> <span class="n">fit_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fit_size</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">photometry</span> <span class="o">=</span> <span class="n">BasicPSFPhotometry</span><span class="p">(</span>
                        <span class="n">group_maker</span><span class="o">=</span><span class="n">daogroup</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span>
                        <span class="n">psf_model</span><span class="o">=</span><span class="n">psf_model</span><span class="p">,</span>
                        <span class="n">fitter</span><span class="o">=</span><span class="n">LevMarLSQFitter</span><span class="p">(),</span>
                        <span class="n">fitshape</span><span class="o">=</span><span class="p">(</span><span class="n">fit_size</span><span class="p">,</span> <span class="n">fit_size</span><span class="p">))</span>

    <span class="c1"># the bkg is not uniform, so try to get an approximation of it and subtract</span>
    <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                       <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;estimated bkg </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">photometry</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="n">data</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span>
        <span class="n">init_guesses</span><span class="o">=</span><span class="n">xy</span><span class="p">)</span>
    <span class="c1"># plot residual</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">photometry</span><span class="o">.</span><span class="n">get_residual_image</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">catalog</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;x_0&#39;</span><span class="p">,</span> <span class="s1">&#39;y_0&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_unc&#39;</span><span class="p">]])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;residual </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[27]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flxscale</span> <span class="k">for</span> <span class="n">a1100</span><span class="p">:</span> <span class="mf">5.098e+08</span>
<span class="n">beam</span> <span class="n">fwhm</span><span class="p">:</span> <span class="mf">5.0</span> <span class="n">arcsec</span>
<span class="n">beam</span> <span class="n">fwhm_pix</span><span class="p">:</span> <span class="mf">6.666666666666678</span>
 <span class="nb">id</span>        <span class="n">x_0</span>               <span class="n">y_0</span>              <span class="n">flux_fit</span>          <span class="n">flux_unc</span>
<span class="o">---</span> <span class="o">-----------------</span> <span class="o">------------------</span> <span class="o">-----------------</span> <span class="o">------------------</span>
  <span class="mi">1</span>             <span class="mf">208.0</span> <span class="mf">208.99999999998315</span> <span class="mf">31.54838450442993</span> <span class="mf">1.3450173732788633</span>
  <span class="mi">2</span>             <span class="mf">208.0</span> <span class="mf">160.99999951253713</span> <span class="mf">8.453958633859823</span> <span class="mf">1.1748965151829007</span>
  <span class="mi">3</span> <span class="mf">160.3577842481555</span>  <span class="mf">208.9994933199453</span> <span class="mf">93.68762562326465</span> <span class="mf">1.2818049895678545</span>
<span class="n">flxscale</span> <span class="k">for</span> <span class="n">a1400</span><span class="p">:</span> <span class="mf">1.419e+08</span>
<span class="n">beam</span> <span class="n">fwhm</span><span class="p">:</span> <span class="mf">6.363636363636363</span> <span class="n">arcsec</span>
<span class="n">beam</span> <span class="n">fwhm_pix</span><span class="p">:</span> <span class="mf">8.484848484848499</span>
 <span class="nb">id</span>        <span class="n">x_0</span>               <span class="n">y_0</span>              <span class="n">flux_fit</span>           <span class="n">flux_unc</span>
<span class="o">---</span> <span class="o">-----------------</span> <span class="o">------------------</span> <span class="o">------------------</span> <span class="o">------------------</span>
  <span class="mi">1</span>             <span class="mf">208.0</span> <span class="mf">208.99999999998315</span> <span class="mf">17.065861259928255</span> <span class="mf">0.8352588276693459</span>
  <span class="mi">2</span>             <span class="mf">208.0</span> <span class="mf">160.99999951253713</span> <span class="mf">11.433398770062562</span> <span class="mf">0.6275077158473168</span>
  <span class="mi">3</span> <span class="mf">160.3577842481555</span>  <span class="mf">208.9994933199453</span>  <span class="mf">193.9052877649744</span> <span class="mf">0.8813505413240258</span>
<span class="n">flxscale</span> <span class="k">for</span> <span class="n">a2000</span><span class="p">:</span> <span class="mf">6.13e+07</span>
<span class="n">beam</span> <span class="n">fwhm</span><span class="p">:</span> <span class="mf">9.09090909090909</span> <span class="n">arcsec</span>
<span class="n">beam</span> <span class="n">fwhm_pix</span><span class="p">:</span> <span class="mf">12.121212121212139</span>
 <span class="nb">id</span>        <span class="n">x_0</span>               <span class="n">y_0</span>              <span class="n">flux_fit</span>           <span class="n">flux_unc</span>
<span class="o">---</span> <span class="o">-----------------</span> <span class="o">------------------</span> <span class="o">------------------</span> <span class="o">------------------</span>
  <span class="mi">1</span>             <span class="mf">208.0</span> <span class="mf">208.99999999998315</span> <span class="mf">17.513887582159672</span> <span class="mf">0.8018449366080853</span>
  <span class="mi">2</span>             <span class="mf">208.0</span> <span class="mf">160.99999951253713</span> <span class="mf">18.467919670129323</span> <span class="mf">0.7143871584462086</span>
  <span class="mi">3</span> <span class="mf">160.3577842481555</span>  <span class="mf">208.9994933199453</span>  <span class="mf">296.3507151107419</span> <span class="mf">0.8493761245612881</span>
</pre></div>
</div>
<img alt="../_images/tolteca_reduce_50_1.png" src="../_images/tolteca_reduce_50_1.png" />
<p><span class="inputnumrole">In[None]:</span></p>
<p><span class="inputnumrole">In[None]:</span></p>
<div id="spacer"></div>

<a href="../_static/tolteca_reduce/tolteca_reduce.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/tolteca_reduce/tolteca_reduce.ipynb"><button id="binder">Interactive tutorial notebook</button></a></div>
</div>

</div>
      </div>
      
    </div>
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.
    &copy; Copyright Astropy.
    </p>
  </div>
</footer>
  </body>
</html>